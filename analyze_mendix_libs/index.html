<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="assets/tailwindcss.js"></script>
    <style>
        /* Simple transition for collapsible sections */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.open {
            max-height: 2000px; /* Large enough for content */
        }
        /* Improved collapsible transition with huge max-height to prevent cutoff */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.open {
            max-height: 9999px; /* Fixed: Increased significantly to prevent cutting off long lists */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
            font-size: 1.25rem;
        }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script src="assets/vendor-bundle.umd.js"></script>
    <script src="assets/babel.min.js"></script>
    <script type="text/babel">

        // 等价于
        // import * as React from 'react';
        // import ReactDOM from 'react-dom/client';
        // import * as redi from '@wendellhu/redi';
        // import * as rediReact from '@wendellhu/redi/react-bindings';
        // import * as rxjs from 'rxjs';
        // import * as reactSpring from '@react-spring/web';
        const { React, ReactDOM, redi, rediReact, rxjs, reactSpring } = globalThis.__tmp;
        delete globalThis.__tmp;

        const { createIdentifier, setDependencies } = redi;
        const { connectDependencies, useDependency } = rediReact;
        const { useState, useEffect, useReducer, useCallback, Fragment, useMemo, useRef } = React;

        // ===================================================================
        // 1. STATE & COMMUNICATION SERVICES (RPC Architecture) - UNCHANGED
        // ===================================================================
        class MessageStore {
            constructor() { this.log = []; this.listeners = new Set(); }
            addLogEntry(entry) { this.log = [entry, ...this.log.slice(0, 99)]; this.notify(); } // Keep log to 100 entries
            subscribe(listener) { this.listeners.add(listener); return () => this.listeners.delete(listener); }
            notify() { this.listeners.forEach(listener => listener()); }
        }

        const IMessageService = createIdentifier('IMessageService');
        class BrowserMessageService {
            constructor(messageStore) {
                this.messageStore = messageStore;
                this.requestId = 0;
                this.pendingRequests = new Map();
                this.RPC_TIMEOUT = 15000; // 15 seconds for potentially slow analysis
                window.addEventListener('message', this.handleBackendResponse);
            }

            async call(type, payload) {
                const correlationId = `req-${this.requestId++}`;
                const command = { type, payload, correlationId };
                this.messageStore.addLogEntry({ type: 'request', correlationId, command });

                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        if (this.pendingRequests.has(correlationId)) {
                            this.pendingRequests.delete(correlationId);
                            const error = new Error(`RPC call for '${type}' timed out.`);
                            this.messageStore.addLogEntry({ type: 'timeout', correlationId, error: error.message });
                            reject(error);
                        }
                    }, this.RPC_TIMEOUT);

                    this.pendingRequests.set(correlationId, { resolve, reject, timeoutId });
                    window.parent.sendMessage("frontend:message", command);
                });
            }

            handleBackendResponse = (event) => {
                if (event.data?.type !== 'backendResponse') return;
                try {
                    const response = JSON.parse(event.data.data);
                    const { correlationId } = response;
                    if (!this.pendingRequests.has(correlationId)) return;

                    const { resolve, reject, timeoutId } = this.pendingRequests.get(correlationId);
                    clearTimeout(timeoutId);
                    this.pendingRequests.delete(correlationId);
                    this.messageStore.addLogEntry({ type: 'response', correlationId, response });

                    if (response.status === 'success') resolve(response.data);
                    else reject(new Error(response.message || 'Unknown backend error.'));
                } catch (e) {
                    this.messageStore.addLogEntry({ type: 'error', error: "Frontend failed to parse backend response." });
                }
            };
        }
        setDependencies(BrowserMessageService, [MessageStore]);

        // Reusable hook for handling RPC calls
        const useRpc = () => {
            const messageService = useDependency(IMessageService);
            const [state, setState] = useState({ isLoading: false, error: null, data: null });

            const execute = useCallback(async (type, payload) => {
                setState({ isLoading: true, error: null, data: null });
                try {
                    const result = await messageService.call(type, payload);
                    setState({ isLoading: false, error: null, data: result });
                    return result;
                } catch (err) {
                    setState({ isLoading: false, error: err.message, data: null });
                    throw err;
                }
            }, [messageService]);

            return { ...state, execute };
        };

        // ===================================================================
        // 2. REFACTORED & INTERACTIVE UI COMPONENTS
        // ===================================================================

        // --- UI Helper Components ---

        const ChevronDownIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-5 w-5"} viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
            </svg>
        );
        
        const SortIcon = ({ direction }) => {
            if (direction === 'ascending') return <span className="text-gray-600">▲</span>;
            if (direction === 'descending') return <span className="text-gray-600">▼</span>;
            return <span className="text-gray-300">▲▼</span>;
        }

        const CollapsibleSection = ({ title, children, startOpen = true, badge, badgeColor = 'gray' }) => {
            const [isOpen, setIsOpen] = useState(startOpen);
            useEffect(() => { setIsOpen(startOpen); }, [startOpen]);

            return (
                <div className="border rounded-lg bg-white shadow-sm mb-4">
                    <button
                        className="w-full flex justify-between items-center p-3 text-left font-semibold text-lg text-gray-800 bg-gray-50 rounded-t-lg hover:bg-gray-100 focus:outline-none"
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <div className="flex items-center">
                            <span>{title}</span>
                            {badge !== undefined && (
                                <span className={`ml-3 px-2.5 py-0.5 text-xs font-semibold rounded-full bg-${badgeColor}-100 text-${badgeColor}-800`}>
                                    {badge}
                                </span>
                            )}
                        </div>
                        <ChevronDownIcon className={`w-6 h-6 transform transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    <div className={`collapsible-content ${isOpen ? 'open' : ''}`}>
                         <div className="p-4 border-t">{children}</div>
                    </div>
                </div>
            );
        };

        const SummaryCard = ({ title, value, color, onClick }) => (
            <button
                onClick={onClick}
                className={`p-4 rounded-lg text-center cursor-pointer transition-all duration-200 hover:shadow-lg hover:-translate-y-1 bg-${color}-100 w-full focus:outline-none focus:ring-2 focus:ring-${color}-400`}
            >
                <div className={`text-3xl font-bold text-${color}-800`}>{value}</div>
                <div className={`text-sm text-${color}-600 mt-1`}>{title}</div>
            </button>
        );

        // --- Custom Modal for Deletion Plan ---
        const DeletionPlanModal = ({ isOpen, onClose, onConfirm, plan, isProcessing }) => {
            if (!isOpen || !plan) return null;

            const readyCount = plan.results.filter(r => r.status === 'ready').length;
            const errorCount = plan.results.filter(r => r.status !== 'ready').length;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header bg-gray-50 text-gray-800 flex justify-between items-center">
                            <span>Confirm Deletion Plan</span>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                        <div className="modal-body">
                            <p className="mb-4 text-gray-600">
                                You are about to permanently delete <strong className="text-gray-800">{readyCount}</strong> JAR file(s). 
                                This action cannot be undone.
                            </p>

                            {errorCount > 0 && (
                                <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                                    Warning: {errorCount} file(s) cannot be processed (missing or invalid).
                                </div>
                            )}

                            <div className="border rounded bg-gray-50 overflow-hidden text-sm">
                                <div className="max-h-60 overflow-y-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {plan.results.map((item, idx) => (
                                                <tr key={idx}>
                                                    <td className="px-3 py-2 truncate max-w-xs text-gray-700" title={item.filename}>{item.filename}</td>
                                                    <td className="px-3 py-2 whitespace-nowrap">
                                                        {item.status === 'ready' 
                                                            ? <span className="text-green-600 font-medium">Ready</span> 
                                                            : <span className="text-red-600 font-medium">{item.status}</span>
                                                        }
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer bg-gray-50">
                            <button 
                                onClick={onClose} 
                                className="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                                disabled={isProcessing}
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={onConfirm} 
                                className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 flex items-center"
                                disabled={isProcessing || readyCount === 0}
                            >
                                {isProcessing ? (
                                    <>
                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Deleting...
                                    </>
                                ) : (
                                    `Delete ${readyCount} File(s)`
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Data Display Components ---

        const ConflictsTable = ({ conflicts, onLibraryClick, selectedFiles, toggleSelection }) => {
            const conflictLibs = Object.keys(conflicts);
            if (conflictLibs.length === 0) {
                return (
                    <div className="p-6 bg-green-50 border border-green-200 rounded-lg text-center">
                        <h3 className="text-xl font-semibold text-green-800">No Conflicts Detected</h3>
                        <p className="text-green-600">All libraries with identifiable versions appear consistent.</p>
                    </div>
                );
            }
            return (
                /* Added scrollable wrapper */
                <div className="max-h-[60vh] overflow-y-auto pr-2 pb-2">
                    <div className="space-y-3">
                        {conflictLibs.map(libName => (
                            <div key={libName} className="bg-white rounded-md shadow-sm border border-red-200">
                                <h4
                                    className="font-bold text-md p-2 bg-red-100 text-red-900 border-b border-red-200 cursor-pointer hover:bg-red-200 transition-colors flex justify-between sticky top-0 z-0"
                                    onClick={() => onLibraryClick(libName)}
                                >
                                    <span>{libName}</span>
                                    <span className="text-xs font-normal text-red-700 bg-red-200 px-2 py-0.5 rounded">Filter List</span>
                                </h4>
                                <ul className="divide-y divide-gray-200">
                                    {conflicts[libName].map((instance, index) => {
                                        const isUserlib = instance.source === 'userlib' && instance.filename;
                                        const isSelected = isUserlib && selectedFiles.has(instance.filename);
                                        
                                        return (
                                            <li key={index} className={`p-3 grid grid-cols-12 gap-3 items-center ${isSelected ? 'bg-blue-50' : ''}`}>
                                                <div className="col-span-1 flex justify-center">
                                                    {isUserlib ? (
                                                         <input 
                                                            type="checkbox" 
                                                            className="h-4 w-4 text-blue-600 rounded cursor-pointer"
                                                            checked={isSelected}
                                                            onChange={(e) => { e.stopPropagation(); toggleSelection(instance.filename); }}
                                                         />
                                                    ) : (
                                                        <span className="text-gray-300 text-xs">N/A</span>
                                                    )}
                                                </div>
                                                <div className="col-span-2 font-semibold text-gray-800">{instance.version}</div>
                                                <div className="col-span-2 text-center">
                                                     <span className={`px-2 py-1 text-xs font-medium rounded-full text-white ${instance.source === 'userlib' ? 'bg-blue-500' : 'bg-green-600'}`}>
                                                        {instance.source}
                                                    </span>
                                                </div>
                                                <div className="col-span-7 text-gray-600 text-sm truncate" title={instance.details}>{instance.details}</div>
                                            </li>
                                        );
                                    })}
                                </ul>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const useSortableData = (items, config = { key: 'library_name', direction: 'ascending' }) => {
            const [sortConfig, setSortConfig] = useState(config);

            const sortedItems = useMemo(() => {
                let sortableItems = [...items];
                if (sortConfig !== null) {
                    sortableItems.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [items, sortConfig]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig && sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            return { items: sortedItems, requestSort, sortConfig };
        };

        const AllDependenciesTable = ({ dependencies, filter, setFilter }) => {
            const { items: sortedDeps, requestSort, sortConfig } = useSortableData(dependencies);
            
            const filteredDeps = useMemo(() => 
                sortedDeps.filter(dep => 
                    dep.library_name.toLowerCase().includes(filter.toLowerCase()) || 
                    dep.version.toLowerCase().includes(filter.toLowerCase())
                ), 
            [sortedDeps, filter]);

            const SortableHeader = ({ children, name }) => (
                <th scope="col" className="px-4 py-3 cursor-pointer hover:bg-gray-200" onClick={() => requestSort(name)}>
                    <div className="flex items-center justify-between">
                        {children}
                        <SortIcon direction={sortConfig?.key === name ? sortConfig.direction : null} />
                    </div>
                </th>
            );

            return (
                <div>
                     <input 
                        type="text" 
                        placeholder={`Filter ${dependencies.length} dependencies by name or version...`}
                        value={filter}
                        onChange={e => setFilter(e.target.value)}
                        className="w-full p-2 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <div className="overflow-auto bg-white rounded-lg shadow" style={{maxHeight: '60vh'}}>
                        <table className="w-full text-sm text-left text-gray-700">
                            <thead className="text-xs text-gray-800 uppercase bg-gray-100 sticky top-0">
                                <tr>
                                    <SortableHeader name="library_name">Library Name</SortableHeader>
                                    <SortableHeader name="version">Version</SortableHeader>
                                    <SortableHeader name="source">Source</SortableHeader>
                                    <th scope="col" className="px-4 py-3">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredDeps.length > 0 ? filteredDeps.map((dep, index) => (
                                    <tr key={index} className="border-b hover:bg-gray-50">
                                        <td className="px-4 py-2 font-medium">{dep.library_name}</td>
                                        <td className="px-4 py-2">{dep.version}</td>
                                        <td className="px-4 py-2">{dep.source}</td>
                                        <td className="px-4 py-2 text-gray-600 truncate max-w-xs" title={dep.details}>{dep.details}</td>
                                    </tr>
                                )) : (
                                    <tr>
                                        <td colSpan="4" className="text-center py-8 text-gray-500">No dependencies match your filter.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const JarAnalysisTool = () => {
            // ==================================================================================
            // RPC HOOK SEPARATION (CRITICAL FIX)
            // ==================================================================================
            // We use two separate instances of the useRpc hook.
            // 1. analysisRpc: Manages the main dataset (the JAR list). Its 'data' state persists
            //    and drives the main UI.
            const analysisRpc = useRpc();
            
            // 2. actionRpc: Manages transient actions (like Delete). We separate this so that
            //    calling DELETE doesn't overwrite 'analysisRpc.data' with the deletion result,
            //    which would cause the main UI table to crash (due to missing fields).
            const actionRpc = useRpc();

            // Destructure states with clear names to distinguish between viewing and acting
            const { 
                data: analysisData, 
                isLoading: isAnalyzing, 
                error: analysisError 
            } = analysisRpc;

            const { 
                isLoading: isActionProcessing 
            } = actionRpc;

            // ==================================================================================

            const [filter, setFilter] = useState('');
            
            // Deletion State
            const [selectedFiles, setSelectedFiles] = useState(new Set());
            const [modalOpen, setModalOpen] = useState(false);
            const [deletionPlan, setDeletionPlan] = useState(null);
            
            // We rely on the rpc loading state, but keep a local ref if needed for specific logic
            const isBusy = isAnalyzing || isActionProcessing;

            const conflictsRef = useRef(null);
            const dependenciesRef = useRef(null);
            
            const handleAnalyze = useCallback(() => {
                setFilter('');
                setSelectedFiles(new Set()); 
                // Use analysisRpc for the main data fetch
                analysisRpc.execute('ANALYZE_JARS', {});
            }, [analysisRpc]);

            const toggleSelection = (filename) => {
                const newSet = new Set(selectedFiles);
                if (newSet.has(filename)) newSet.delete(filename);
                else newSet.add(filename);
                setSelectedFiles(newSet);
            };

            const prepareDeletion = async () => {
                if (selectedFiles.size === 0) return;
                try {
                    // Use actionRpc for operations so analysisData remains intact
                    const filenames = Array.from(selectedFiles);
                    const plan = await actionRpc.execute('BATCH_DELETE_JARS', { filenames, dry_run: true });
                    setDeletionPlan(plan);
                    setModalOpen(true);
                } catch (err) {
                    alert(`Failed to prepare deletion: ${err.message}`);
                }
            };

            const confirmDeletion = async () => {
                if (!deletionPlan) return;
                try {
                    // Use actionRpc for the actual delete command
                    const filenames = Array.from(selectedFiles);
                    const result = await actionRpc.execute('BATCH_DELETE_JARS', { filenames, dry_run: false });
                    
                    setModalOpen(false); 
                    setSelectedFiles(new Set()); 
                    
                    setTimeout(() => {
                         alert(`Deletion Complete.\n${result.summary}`);
                         // Refresh the main list after successful action
                         handleAnalyze(); 
                    }, 100);

                } catch (err) {
                    alert(`Error during deletion: ${err.message}`);
                    setModalOpen(false);
                }
            };

            const scrollTo = (ref) => ref.current?.scrollIntoView({ behavior: 'smooth' });

            return (
                <div className="p-4 md:p-6 max-w-6xl mx-auto">
                    <header className="bg-white shadow-md rounded-lg p-4 mb-6 flex flex-col md:flex-row justify-between items-center sticky top-0 z-10">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800">JAR Conflict Visualizer</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <p className="text-gray-600 text-sm">Analyze and resolve dependency conflicts.</p>
                                {selectedFiles.size > 0 && (
                                     <span className="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">
                                        {selectedFiles.size} file(s) selected
                                     </span>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-3 mt-4 md:mt-0 w-full md:w-auto">
                            {selectedFiles.size > 0 && (
                                <button 
                                    onClick={prepareDeletion}
                                    className="px-6 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition-colors disabled:opacity-50"
                                    disabled={isBusy}
                                >
                                    {isActionProcessing ? 'Processing...' : `Delete Selected (${selectedFiles.size})`}
                                </button>
                            )}
                            <button 
                                onClick={handleAnalyze} 
                                className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-wait" 
                                disabled={isBusy}
                            >
                                {isAnalyzing ? 'Analyzing...' : 'Run Analysis'}
                            </button>
                        </div>
                    </header>

                    <main>
                        {analysisError && <div className="p-4 mb-4 bg-red-100 text-red-800 rounded-md"><strong>Error:</strong> {analysisError}</div>}
                        
                        {/* Use analysisData to render the UI. This data persists even when actionRpc is loading. */}
                        {analysisData && (
                            <div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <SummaryCard title="Userlib JARs" value={analysisData.summary.userlib_count} color="blue" onClick={() => scrollTo(dependenciesRef)} />
                                    <SummaryCard title="Vendorlib JARs" value={analysisData.summary.sbom_count} color="green" onClick={() => scrollTo(dependenciesRef)} />
                                    <SummaryCard title="Total Dependencies" value={analysisData.summary.total_count} color="purple" onClick={() => scrollTo(dependenciesRef)} />
                                    <SummaryCard title="Conflicts Found" value={analysisData.summary.conflict_count} color={analysisData.summary.conflict_count > 0 ? 'red' : 'gray'} onClick={() => scrollTo(conflictsRef)} />
                                </div>

                                <div ref={conflictsRef}>
                                    <CollapsibleSection
                                        title="Conflict Analysis"
                                        startOpen={analysisData.summary.conflict_count > 0}
                                        badge={analysisData.summary.conflict_count}
                                        badgeColor={analysisData.summary.conflict_count > 0 ? 'red' : 'green'}
                                    >
                                        <ConflictsTable 
                                            conflicts={analysisData.conflicts} 
                                            onLibraryClick={(libName) => {
                                                setFilter(libName);
                                                scrollTo(dependenciesRef);
                                            }}
                                            selectedFiles={selectedFiles}
                                            toggleSelection={toggleSelection}
                                        />
                                    </CollapsibleSection>
                                </div>
                                
                                <div ref={dependenciesRef}>
                                    <CollapsibleSection title="Full Dependency List" badge={analysisData.dependencies.length}>
                                        <AllDependenciesTable dependencies={analysisData.dependencies} filter={filter} setFilter={setFilter} />
                                    </CollapsibleSection>
                                </div>
                            </div>
                        )}

                        {!isAnalyzing && !analysisData && !analysisError && (
                             <div className="text-center py-16 bg-white rounded-lg shadow-md">
                                <h2 className="text-xl text-gray-700">Ready to find conflicts?</h2>
                                <p className="text-gray-500 mt-2">Click "Run Analysis" to begin.</p>
                            </div>
                        )}
                    </main>

                    <DeletionPlanModal 
                        isOpen={modalOpen} 
                        onClose={() => setModalOpen(false)} 
                        onConfirm={confirmDeletion}
                        plan={deletionPlan}
                        isProcessing={isActionProcessing}
                    />
                </div>
            );
        };
        
        // ===================================================================
        // 3. MAIN APP & IOC CONFIGURATION - UNCHANGED
        // ===================================================================
        const AppWithDependencies = connectDependencies(JarAnalysisTool, [
            [MessageStore],
            [IMessageService, { useClass: BrowserMessageService }],
        ]);

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<AppWithDependencies />);
    </script>
</body>

</html>