<!-- https://gist.github.com/engalar/b84b71693c4d1a8addd458e4eec53da3 -->
<!-- gh gist edit b84b71693c4d1a8addd458e4eec53da3 .\index.html -f index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple plugin demo</title>
    <!-- 框架依赖: React, Tailwind, Babel, VConsole (引入本地资源，以便离线使用) -->
    <script src="assets/react.development.js"></script>
    <script src="assets/react-dom.development.js"></script>
    <script src="assets/tailwindcss.js"></script>
    <script src="assets/babel.min.js"></script>
    <script src="assets/vconsole.min.js"></script>
    <script>new VConsole();</script>

</head>

<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [inputValue, setInputValue] = useState('');
            const [receivedMessages, setReceivedMessages] = useState([]);

            // Function to send messages to the Mendix Studio Pro backend
            const sendMessageToBackend = () => {
                if (inputValue.trim() === '') {
                    return;
                }

                // Construct the message object to send
                // The backend's onMessage function expects a 'Data' field which will be our message_object
                // The C# host environment will wrap the second argument into e.Data
                const messageObject = {
                    timestamp: new Date().toISOString(),
                    content: inputValue,
                    sender: 'frontend'
                };

                // Send the message to the C# host, which forwards it to the Python backend
                window.parent.sendMessage("frontend:message", messageObject);
                setInputValue(''); // Clear the input field
            };

            // Effect hook to set up and tear down the message event listener
            useEffect(() => {
                const handleBackendResponse = (event) => {
                    if (event.data && event.data.type === 'backendResponse') {//对应后端的PostMessage("backend:response", json.dumps(response))
                        try {
                            const payloadString = event.data.data;
                            // Parse the JSON string received from the backend
                            const payload = JSON.parse(payloadString);
                            setReceivedMessages((prevMessages) => [...prevMessages, payload]);
                        } catch (error) {
                            console.error("Error parsing backend response:", error);
                            // Optionally display an error message in the UI
                        }
                    }
                };

                // Add the event listener for messages from the host
                window.addEventListener('message', handleBackendResponse);

                // Cleanup function to remove the event listener when the component unmounts
                return () => {
                    window.removeEventListener('message', handleBackendResponse);
                };
            }, []); // Empty dependency array ensures this runs once on mount and once on unmount

            return (
                <div className="p-4 max-w-2xl mx-auto bg-white shadow-lg rounded-lg mt-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-6">Mendix Plugin Demo</h1>

                    <div className="flex mb-6">
                        <input
                            type="text"
                            className="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                    sendMessageToBackend();
                                }
                            }}
                            placeholder="Type a message to send to the backend..."
                        />
                        <button
                            onClick={sendMessageToBackend}
                            className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                        >
                            Send
                        </button>
                    </div>

                    <div>
                        <h2 className="text-2xl font-semibold text-gray-800 mb-3">Received from Backend:</h2>
                        {receivedMessages.length === 0 ? (
                            <p className="text-gray-600 italic">No messages received yet. Send something!</p>
                        ) : (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 h-64 overflow-y-auto">
                                {receivedMessages.map((msg, index) => (
                                    <div key={index} className="mb-3 p-3 bg-white rounded-md shadow-sm last:mb-0">
                                        <pre className="text-sm text-gray-800 whitespace-pre-wrap font-mono">
                                            {JSON.stringify(msg, null, 2)}
                                        </pre>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>