<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script src="assets/tailwindcss.js"></script>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script src="assets/vendor-bundle.umd.js"></script>
    <script src="assets/babel.min.js"></script>
    <script type="text/babel">

        // ===================================================================
        // ===================     FRAMEWORK CODE     ========================
        // ===================================================================
        // This section contains the reusable, application-agnostic core.
        // You should not need to modify this section to add new features.
        // -------------------------------------------------------------------

        // 等价于
        // import * as React from 'react';
        // import ReactDOM from 'react-dom/client';
        // import * as redi from '@wendellhu/redi';
        // import * as rediReact from '@wendellhu/redi/react-bindings';
        // import * as rxjs from 'rxjs';
        // import * as reactSpring from '@react-spring/web';
        const { React, ReactDOM, redi, rediReact, rxjs, reactSpring } = globalThis.__tmp;
        delete globalThis.__tmp;

        // keep unused import for redi and rediReact
        const {
            Inject,
            Injector,
            LookUp,
            Many,
            Optional,
            Quantity,
            RediError,
            Self,
            SkipSelf,
            WithNew,
            createIdentifier,
            forwardRef,
            isAsyncDependencyItem,
            isAsyncHook,
            isClassDependencyItem,
            isCtor,
            isDisposable,
            isFactoryDependencyItem,
            isValueDependencyItem,
            setDependencies,
        } = redi;
        const {
            RediConsumer,
            RediContext,
            RediProvider,
            WithDependency,
            connectDependencies,
            connectInjector,
            useDependency,
            useInjector,
            useObservable,
            useUpdateBinder,
        } = rediReact;
        const {
            useState,
            useEffect,
            useRef,
            useMemo,
            useReducer,
            Fragment,
            useCallback,
            createContext,
            useContext,
        } = React;
        const { BehaviorSubject, Subject, fromEvent, map, filter } = rxjs;
        const { useSpring, useTransition, animated } = reactSpring;

        // 1. FRAMEWORK: CORE COMMUNICATION SERVICES


        const IApiService = createIdentifier('IApiService');

        class ApiService {
            constructor() {
                this.reqIdCounter = 0;
                this.pendingRpcs = new Map();
                this.activeJobs = new Map();
                this.activeSessions = new Map();
                this.broadcastChannels = new Map();

                fromEvent(window, 'message')
                    .pipe(filter(event => event.data && event.data.type === 'backendResponse'))
                    .pipe(map(event => JSON.parse(event.data.data)))
                    .subscribe(msg => this._handleBackendMessage(msg));
            }

            // --- Public Methods for Hooks ---

            rpc(method, params) {
                return new Promise((resolve, reject) => {
                    const reqId = `req-${this.reqIdCounter++}`;
                    this.pendingRpcs.set(reqId, { resolve, reject });
                    this._sendMessage({ type: 'RPC', reqId, method, params });
                    setTimeout(() => {
                        if (this.pendingRpcs.has(reqId)) {
                            this.pendingRpcs.delete(reqId);
                            reject(new Error(`RPC call '${method}' timed out.`));
                        }
                    }, 10000);
                });
            }

            startJob(method, params) {
                const subject = new Subject();
                const reqId = `req-${this.reqIdCounter++}`;

                const promise = new Promise((resolve, reject) => {
                    this.pendingRpcs.set(reqId, {
                        resolve: ({ jobId }) => {
                            this.activeJobs.set(jobId, subject);
                            resolve({ jobId }); // Resolve promise with jobId once started
                        },
                        reject
                    });
                });

                this._sendMessage({ type: 'JOB_START', reqId, method, params });
                return { startPromise: promise, updates$: subject.asObservable() };
            }

            connectSession(channel, payload) {
                const sessionId = `${channel}-${Math.random().toString(36).substr(2, 9)}`;
                if (!this.activeSessions.has(sessionId)) {
                    const subject = new Subject();
                    this.activeSessions.set(sessionId, subject);
                    this._sendMessage({ type: 'SESSION_CONNECT', sessionId, channel, payload });
                }
                return { sessionId, messages$: this.activeSessions.get(sessionId).asObservable() };
            }

            disconnectSession(sessionId, channel) {
                if (this.activeSessions.has(sessionId)) {
                    this.activeSessions.get(sessionId).complete();
                    this.activeSessions.delete(sessionId);
                    this._sendMessage({ type: 'SESSION_DISCONNECT', sessionId, channel });
                }
            }

            subscribeBroadcast(channel) {
                if (!this.broadcastChannels.has(channel)) {
                    this.broadcastChannels.set(channel, new Subject());
                }
                return this.broadcastChannels.get(channel).asObservable();
            }

            // --- Internal Message Handling ---

            _sendMessage(data) {
                window.parent.sendMessage('frontend:message', data);
            }

            _handleBackendMessage(msg) {
                const { type, reqId, jobId, sessionId, channel } = msg;

                switch (type) {
                    case 'RPC_SUCCESS':
                        this.pendingRpcs.get(reqId)?.resolve(msg.data);
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'RPC_ERROR':
                        this.pendingRpcs.get(reqId)?.reject({ message: msg.message, traceback: msg.traceback });
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'JOB_STARTED':
                        this.pendingRpcs.get(reqId)?.resolve({ jobId });
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'JOB_PROGRESS':
                        this.activeJobs.get(jobId)?.next({ type: 'progress', ...msg });
                        break;
                    case 'JOB_SUCCESS':
                        this.activeJobs.get(jobId)?.next({ type: 'success', ...msg });
                        this.activeJobs.get(jobId)?.complete();
                        this.activeJobs.delete(jobId);
                        break;
                    case 'JOB_ERROR':
                        this.activeJobs.get(jobId)?.next({ type: 'error', ...msg });
                        this.activeJobs.get(jobId)?.complete();
                        this.activeJobs.delete(jobId);
                        break;
                    case 'EVENT_BROADCAST':
                        this.broadcastChannels.get(channel)?.next(msg.data);
                        break;
                    case 'EVENT_SESSION':
                        this.activeSessions.get(sessionId)?.next(msg.data);
                        break;
                }
            }
        }
        setDependencies(ApiService, []);

        // --- High-Level React Hooks (Simplifying Boilerplate) ---

        function useRpc(method) {
            const api = useDependency(IApiService);
            const [state, setState] = useState({ isLoading: false, data: null, error: null });

            const execute = useCallback(async (params) => {
                setState({ isLoading: true, data: null, error: null });
                try {
                    const result = await api.rpc(method, params);
                    setState({ isLoading: false, data: result, error: null });
                    return result;
                } catch (err) {
                    setState({ isLoading: false, data: null, error: err });
                    throw err;
                }
            }, [api, method]);
            return { ...state, execute };
        }

        const initialJobState = { status: 'idle', progress: { percent: 0, message: '' }, data: null, error: null };
        function useJob(method) {
            const api = useDependency(IApiService);
            const [state, setState] = useState(initialJobState);
            const subRef = useRef(null);

            const start = useCallback((params) => {
                setState({ ...initialJobState, status: 'starting' });
                const { startPromise, updates$ } = api.startJob(method, params);

                startPromise.then(({ jobId }) => {
                    subRef.current = updates$.subscribe({
                        next: (update) => {
                            if (update.type === "JOB_PROGRESS") setState(s => ({ ...s, status: 'running', progress: update.progress }));
                            else if (update.type === "JOB_SUCCESS") setState(s => {
                                s.progress.percent = 100;
                                return { ...s, status: 'success', data: update.data };
                            })
                            else if (update.type === 'JOB_ERROR') setState(s => ({ ...s, status: 'error', error: { message: update.message, traceback: update.traceback } }));
                        },
                        error: (err) => setState(s => ({ ...s, status: 'error', error: err })),
                        complete: () => {
                            // Handled by success/error messages
                        }
                    });
                }).catch(err => {
                    setState({ ...initialJobState, status: 'error', error: err });
                });
            }, [api, method]);

            useEffect(() => {
                // Cleanup subscription on unmount
                return () => subRef.current?.unsubscribe();
            }, []);

            return { ...state, start };
        }

        function usePush(channel, options = {}) {
            const api = useDependency(IApiService);
            const [latestMessage, setLatestMessage] = useState(null);

            useEffect(() => {
                let sub;
                let sessionId;

                if (options.isSession) {
                    const session = api.connectSession(channel, options.payload);
                    sessionId = session.sessionId;
                    sub = session.messages$.subscribe(setLatestMessage);
                } else {
                    sub = api.subscribeBroadcast(channel).subscribe(setLatestMessage);
                }

                return () => {
                    sub?.unsubscribe();
                    if (sessionId) {
                        api.disconnectSession(sessionId, channel);
                    }
                };
            }, [api, channel, options.isSession, JSON.stringify(options.payload)]); // re-run if payload changes

            return { latestMessage };
        }

        // 2. REFACTORED: Panel Service powered by RxJS
        const IPanel = createIdentifier("IPanel");
        const IPanelService = createIdentifier("IPanelService");
        class PanelService {
            constructor(panels) {
                this.allPanels = new Map(panels.map(p => [p.id, p]));

                // Internal state managed by a BehaviorSubject
                this._state$ = new BehaviorSubject(this.getInitialState());

                // Publicly exposed observable stream of the state
                this.state$ = this._state$.asObservable();
            }

            getInitialState() {
                const initialOpenIds = new Set(
                    Array.from(this.allPanels.values())
                        .filter(p => p.defaultActive)
                        .map(p => p.id)
                );
                const initialActiveId = Array.from(this.allPanels.values())
                    .find(p => p.defaultActive)?.id || null;
                return this._computeState(initialOpenIds, initialActiveId);
            }

            // Private method to compute the full state object from IDs
            _computeState(openPanelIds, activePanelId) {
                const openPanels = Array.from(openPanelIds)
                    .map(id => this.allPanels.get(id))
                    .filter(Boolean); // Filter out potential undefineds
                const activePanel = activePanelId ? this.allPanels.get(activePanelId) : null;

                return { openPanels, activePanel };
            }

            // Private method to update the stream
            _updateState(newOpenIds, newActiveId) {
                const newState = this._computeState(newOpenIds, newActiveId);
                this._state$.next(newState);
            }

            // --- Public API for Panel Control ---
            openPanel(id) {
                if (!this.allPanels.has(id)) return;

                const currentState = this._state$.getValue();
                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));

                if (currentOpenIds.has(id)) {
                    this.setActivePanel(id);
                    return;
                }

                currentOpenIds.add(id);
                this._updateState(currentOpenIds, id);
            }

            closePanel(id) {
                const currentState = this._state$.getValue();
                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));
                if (!currentOpenIds.has(id)) return;

                currentOpenIds.delete(id);
                let newActiveId = currentState.activePanel?.id;
                if (newActiveId === id) {
                    newActiveId = currentOpenIds.values().next().value || null;
                }
                this._updateState(currentOpenIds, newActiveId);
            }

            setActivePanel(id) {
                const currentState = this._state$.getValue();
                if (currentState.activePanel?.id === id) return;

                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));
                if (!currentOpenIds.has(id)) return; // Can't activate a panel that isn't open

                this._updateState(currentOpenIds, id);
            }
        }
        setDependencies(PanelService, [[new Many(), IPanel]]);

        // 3. REFACTORED: The App Shell Component, now a pure projection of state
        const AppShell = () => {
            const panelService = useDependency(IPanelService);

            // Subscribe to the state stream.
            const { openPanels, activePanel } = useObservable(
                panelService.state$,
                panelService.getInitialState()
            );

            // Setup transitions for the active panel
            const panelTransitions = useTransition(activePanel, {
                key: panel => panel?.id,
                from: { opacity: 0, transform: 'translateY(10px)' },
                enter: { opacity: 1, transform: 'translateY(0px)' },
                leave: { opacity: 0, transform: 'translateY(-10px)', position: 'absolute', top: 0, left: 0, right: 0 },
                config: { tension: 220, friction: 25 },
            });

            return (
                <div className="p-4 max-w-5xl mx-auto bg-gray-50 shadow-lg rounded-lg mt-8 flex flex-col h-[90vh]">
                    <h1 className="text-3xl font-bold text-gray-800 mb-4 text-center">
                        Mendix Portal Control Panel (RxJS)
                    </h1>
                    <div className="flex border-b border-gray-300">
                        {openPanels.map(panel => (
                            <button
                                key={panel.id}
                                onClick={() => panelService.setActivePanel(panel.id)}
                                className={`px-4 py-2 text-sm font-medium border-b-2 ${panel.id === activePanel?.id ? 'border-purple-600 text-purple-700' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                {panel.title}
                            </button>
                        ))}
                    </div>
                    <div className="flex-grow p-4 bg-white relative overflow-hidden">
                        {panelTransitions((style, panel) =>
                            panel ? (
                                <animated.div style={style} className="w-full h-full">
                                    <panel.component />
                                </animated.div>
                            ) : (
                                <div className="text-center text-gray-500">No panel selected.</div>
                            )
                        )}
                    </div>
                </div>
            );
        };

        const Alert = ({ message, type, style }) => {
            const baseClasses = "text-sm px-4 py-2 rounded-md";
            const typeClasses = {
                success: "bg-green-100 text-green-800",
                error: "bg-red-100 text-red-800",
            };
            return <animated.div style={style} className={`${baseClasses} ${typeClasses[type]}`}>{message}</animated.div>;
        };
        const ErrorDisplay = ({ error }) => {
            if (!error) return null;
            const [showTraceback, setShowTraceback] = useState(false);

            return (
                <div className="mt-4 p-3 bg-red-100 text-red-800 rounded-lg border border-red-200">
                    <div className="flex justify-between items-center">
                        <p className="font-semibold break-all">Error: {error.message}</p>
                        {error.traceback && (
                            <button
                                onClick={() => setShowTraceback(!showTraceback)}
                                className="text-xs text-red-600 hover:text-red-800 font-medium ml-4 flex-shrink-0"
                            >
                                {showTraceback ? 'Hide Details' : 'Show Details'}
                            </button>
                        )}
                    </div>
                    {showTraceback && error.traceback && (
                        <pre className="mt-3 p-2 bg-red-50 text-xs text-red-900 overflow-auto rounded font-mono">
                            <code>{error.traceback}</code>
                        </pre>
                    )}
                </div>
            );
        };


        // ===================================================================
        // ===============     BUSINESS LOGIC CODE     =======================
        // ===================================================================
        // This section contains your feature-specific components (Views).
        // To add a new feature, add your new Component here and register
        // it as an `IView` in the IOC Configuration section below.
        // -------------------------------------------------------------------
        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                namespace: <path strokeLinecap="round" strokeLinejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />,
                class: <path strokeLinecap="round" strokeLinejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />,
                interface: <path strokeLinecap="round" strokeLinejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />,
                struct: <path strokeLinecap="round" strokeLinejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />,
                enum: <path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />,
                chevron: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M9 5l7 7-7 7" />
            };
            return (
                <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    {icons[name] || icons.class}
                </svg>
            );
        }; const ResizablePanel = ({ left, right, initialWidth = 33.33 }) => {
            const [width, setWidth] = useState(initialWidth);
            const isResizing = useRef(false);
            const containerRef = useRef(null);

            const handleMouseDown = (e) => {
                isResizing.current = true;
                e.preventDefault();
            };

            const handleMouseUp = () => {
                isResizing.current = false;
            };

            const handleMouseMove = useCallback((e) => {
                if (!isResizing.current || !containerRef.current) return;
                const containerRect = containerRef.current.getBoundingClientRect();
                const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                // Clamp the width between 15% and 75%
                setWidth(Math.max(15, Math.min(75, newWidth)));
            }, []);

            useEffect(() => {
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [handleMouseMove]);

            return (
                <div ref={containerRef} className="flex h-full w-full">
                    <aside style={{ width: `${width}%` }} className="h-full flex-shrink-0">
                        {left}
                    </aside>
                    <div
                        onMouseDown={handleMouseDown}
                        className="w-1.5 flex-shrink-0 bg-gray-200 hover:bg-blue-400 cursor-col-resize"
                    />
                    <main style={{ width: `${100 - width}%` }} className="h-full flex-shrink-0">
                        {right}
                    </main>
                </div>
            );
        }; const TreeView = ({ data, onSelect, initialExpanded = false }) => {
            const [expandedNodes, setExpandedNodes] = useState(() => new Set());

            const allNodeIds = useMemo(() => {
                const ids = new Set();
                const traverse = (nodes, parentPath) => {
                    nodes.forEach(node => {
                        const currentPath = `${parentPath}/${node.id}`;
                        if (node.children) {
                            ids.add(currentPath);
                            traverse(node.children, currentPath);
                        }
                    });
                };
                traverse(data, 'root');
                return ids;
            }, [data]);

            useEffect(() => {
                if (initialExpanded) setExpandedNodes(allNodeIds);
            }, [initialExpanded, allNodeIds]);

            const toggleNode = (nodePath) => {
                setExpandedNodes(prev => {
                    const next = new Set(prev);
                    if (next.has(nodePath)) {
                        next.delete(nodePath);
                    } else {
                        next.add(nodePath);
                    }
                    return next;
                });
            };

            const expandAll = () => setExpandedNodes(allNodeIds);
            const collapseAll = () => setExpandedNodes(new Set());

            return (
                <div className="p-1 text-sm">
                    <div className="flex space-x-2 p-1 mb-1 border-b">
                        <button onClick={expandAll} className="text-xs px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded">Expand All</button>
                        <button onClick={collapseAll} className="text-xs px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded">Collapse All</button>
                    </div>
                    {data.map(node => (
                        <TreeNode key={node.id} node={node} onSelect={onSelect} expandedNodes={expandedNodes} toggleNode={toggleNode} path={`root/${node.id}`} />
                    ))}
                </div>
            );
        };

        const TreeNode = ({ node, onSelect, expandedNodes, toggleNode, path }) => {
            const { useMemo } = React;
            const isExpanded = useMemo(() => expandedNodes.has(path), [expandedNodes, path]);
            const isParent = node.children && node.children.length > 0;
            const isSelectable = !!node.data;

            const handleToggle = () => {
                if (isParent) toggleNode(path);
            };

            const handleSelect = () => {
                if (isSelectable) onSelect(node.data);
            };

            return (
                <div className="pl-4">
                    <div
                        onClick={isSelectable ? handleSelect : handleToggle}
                        className={`flex items-center space-x-1 py-0.5 rounded cursor-pointer ${isSelectable ? 'hover:bg-blue-100' : ''} ${node.isSelected ? 'bg-blue-200 font-semibold' : ''}`}
                    >
                        {isParent && (
                            <button onClick={e => { e.stopPropagation(); handleToggle(); }} className="p-0.5 rounded-full hover:bg-gray-200">
                                <Icon name="chevron" className={`w-2 h-2 transform transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                            </button>
                        )}
                        {!isParent && <div className="w-3" />}
                        <Icon name={node.icon} className="w-3.5 h-3.5 flex-shrink-0 text-gray-600" />
                        <span className="truncate">{node.label}</span>
                    </div>
                    {isExpanded && isParent && (
                        <div>
                            {node.children.map(child => (
                                <TreeNode key={child.id} node={child} onSelect={onSelect} expandedNodes={expandedNodes} toggleNode={toggleNode} path={`${path}/${child.id}`} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        const Badge = ({ children, color = 'gray' }) => {
            const colors = {
                gray: 'bg-gray-200 text-gray-700',
                blue: 'bg-blue-200 text-blue-700',
                purple: 'bg-purple-200 text-purple-700',
                green: 'bg-green-200 text-green-700',
                yellow: 'bg-yellow-200 text-yellow-700',
            };
            return <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${colors[color]}`}>{children}</span>;
        };



        const CollapsibleSectionContext = createContext(null);

        const CollapsibleSection = ({ title, count, children, defaultOpen = false, id }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            const context = useContext(CollapsibleSectionContext);

            useEffect(() => {
                if (context?.command === 'expand') setIsOpen(true);
                if (context?.command === 'collapse') setIsOpen(false);
            }, [context?.command]);

            if (count === 0) return null;
            return (
                <div className="border-t mt-2 pt-1">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full text-left flex justify-between items-center py-1 font-semibold text-gray-700 hover:text-gray-900 focus:outline-none text-sm">
                        <span>{title} ({count})</span>
                        <Icon name="chevron" className={`w-2.5 h-2.5 transform transition-transform ${isOpen ? 'rotate-90' : ''}`} />
                    </button>
                    {isOpen && <div className="pl-2 mt-1">{children}</div>}
                </div>
            );
        }

        const TypeDetail = ({ type }) => {
            if (!type) return <div className="flex items-center justify-center h-full text-gray-500">Select a type from the list to see its details.</div>;

            const [command, setCommand] = useState(null);

            const typeColors = { Class: 'blue', Interface: 'purple', Struct: 'green', Enum: 'yellow' };

            useEffect(() => {
                // Reset command after render to allow re-triggering
                if (command) setCommand(null);
            }, [command]);

            return (
                <CollapsibleSectionContext.Provider value={{ command }}>
                    <div className="p-2 h-full overflow-y-auto text-sm">
                        {/* Header */}
                        <div className="sticky top-0 bg-white/80 backdrop-blur-sm z-10 pb-2 -mt-2 pt-2">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800">{type.name}</h3>
                                    <div className="text-xs text-gray-500 mb-1 break-all">{type.namespace}</div>
                                </div>
                                <div className="flex space-x-2 flex-shrink-0 mt-1">
                                    <button onClick={() => setCommand('expand')} className="text-xs px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded">Expand All</button>
                                    <button onClick={() => setCommand('collapse')} className="text-xs px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded">Collapse All</button>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mb-2">
                                <Badge color={typeColors[type.typeKind]}>{type.typeKind}</Badge>
                                {type.isPublic && <Badge>public</Badge>}
                                {type.isAbstract && <Badge>abstract</Badge>}
                                {type.isSealed && <Badge>sealed</Badge>}
                            </div>
                            {type.baseType && type.baseType !== 'System.Object' && type.baseType !== 'System.ValueType' && type.baseType !== 'System.Enum' && (
                                <div className="text-xs mb-0.5"><strong>Inherits:</strong> <span className="font-mono bg-gray-100 px-1 py-0.5 rounded">{type.baseType}</span></div>
                            )}
                            {type.interfaces.length > 0 && (
                                <div className="text-xs"><strong>Implements:</strong> <span className="font-mono bg-gray-100 px-1 py-0.5 rounded">{type.interfaces.join(', ')}</span></div>
                            )}
                        </div>

                        {type.enumValues && (
                            <CollapsibleSection title="Enum Values" count={type.enumValues?.length} defaultOpen={true}>
                                <ul className="list-disc list-inside font-mono text-xs space-y-0.5">
                                    {type.enumValues.map(v => <li key={v}>{v}</li>)}
                                </ul>
                            </CollapsibleSection>
                        )}
                        <CollapsibleSection title="Properties" count={type.properties.length}>
                            {type.properties.map(p => (
                                <div key={p.name} className="font-mono text-xs py-0.5">
                                    <span className="text-purple-600">{p.type}</span> <span className="font-bold text-gray-800">{p.name}</span> {'{'}
                                    {p.canRead && <span className="text-green-600"> get; </span>}
                                    {p.canWrite && <span className="text-blue-600"> set; </span>}
                                    {'}'}
                                </div>
                            ))}
                        </CollapsibleSection>

                        <CollapsibleSection title="Constructors" count={type.constructors.length}>
                            {type.constructors.map((c, i) => (
                                <div key={`${type.name}-ctor-${i}`} className="font-mono text-xs py-0.5">
                                    <span className="font-bold text-gray-800">{type.name}</span>
                                    (
                                    {c.parameters.length > 0
                                        ? c.parameters.map(p => <span key={p.name}><span className="text-purple-500">{p.type}</span> {p.name}</span>).reduce((prev, curr) => [prev, ', ', curr])
                                        : null
                                    }
                                    )
                                </div>
                            ))}
                        </CollapsibleSection>

                        <CollapsibleSection title="Methods" count={type.methods.length}>
                            {type.methods.map(m => (
                                <div key={`${m.name}-${m.parameters.map(p => p.type).join('-')}`} className="font-mono text-xs py-0.5">
                                    {m.isStatic && <span className="text-gray-500">static </span>}
                                    <span className="text-purple-600">{m.returnType}</span> <span className="font-bold text-gray-800">{m.name}</span>
                                    (
                                    {m.parameters.length > 0
                                        ? m.parameters.map(p => <span key={p.name}><span className="text-purple-500">{p.type}</span> {p.name}</span>).reduce((prev, curr) => [prev, ', ', curr])
                                        : null
                                    }
                                    )
                                </div>
                            ))}
                        </CollapsibleSection>

                        <CollapsibleSection title="Events" count={type.events.length}>
                            {type.events.map(e => (
                                <div key={e.name} className="font-mono text-xs py-0.5">
                                    <span className="font-bold text-orange-600">event</span> <span className="text-purple-600">{e.type}</span> <span className="font-bold text-gray-800">{e.name}</span>
                                </div>
                            ))}
                        </CollapsibleSection>

                        <CollapsibleSection title="Fields" count={type.fields.length}>
                            {type.fields.map(f => (
                                <div key={f.name} className="font-mono text-xs py-0.5">
                                    {f.isStatic && <span className="text-gray-500">static </span>}
                                    <span className="text-purple-600">{f.type}</span> <span className="font-bold text-gray-800">{f.name}</span>
                                </div>
                            ))}
                        </CollapsibleSection>
                    </div>
                </CollapsibleSectionContext.Provider>
            );
        }
        const ApiExplorerPanel = () => {
            const { status, progress, data, error, start } = useJob('reflection:getApiMetadata');
            const [selectedType, setSelectedType] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [isTreeInitiallyExpanded, setIsTreeInitiallyExpanded] = useState(false);
            const { useMemo } = React;

            useEffect(() => {
                if (status === 'idle') start();
            }, [status, start]);

            const iconMap = { Class: 'class', Interface: 'interface', Struct: 'struct', Enum: 'enum' };

            const treeData = useMemo(() => {
                if (!data || !data.namespaces) return [];

                const namespaces = searchTerm ? data.namespaces : data.namespaces;
                const lowerCaseSearch = searchTerm.toLowerCase();

                const namespaceNodes = Object.entries(namespaces).map(([ns, kinds]) => {
                    const kindNodes = Object.entries(kinds).map(([kind, types]) => {
                        const typeNodes = types
                            .filter(t => !searchTerm || t.name.toLowerCase().includes(lowerCaseSearch))
                            .map(t => ({
                                id: t.name,
                                label: t.name,
                                icon: iconMap[t.typeKind] || 'class',
                                data: t,
                                isSelected: selectedType?.fullName === t.fullName
                            }));

                        if (typeNodes.length === 0) return null;

                        return {
                            id: kind,
                            label: `${kind}s (${typeNodes.length})`,
                            icon: iconMap[kind] || 'class',
                            children: typeNodes
                        };
                    }).filter(Boolean);

                    if (kindNodes.length === 0) return null;

                    return {
                        id: ns,
                        label: ns,
                        icon: 'namespace',
                        children: kindNodes
                    };
                }).filter(Boolean);

                return namespaceNodes;
            }, [data, searchTerm, selectedType]);


            if (status === 'starting' || status === 'running') {
                return (
                    <div className="flex flex-col items-center justify-center h-full">
                        <h2 className="text-xl font-semibold mb-4">Reflecting Mendix.StudioPro.ExtensionsAPI...</h2>
                        <div className="w-full max-w-md bg-gray-200 rounded-full h-2.5">
                            <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${progress.percent}%` }}></div>
                        </div>
                        <p className="mt-2 text-gray-600">{progress.message}</p>
                    </div>
                );
            }

            if (error) return <ErrorDisplay error={error} />;
            if (!data) return <div className="text-center p-8">No reflection data available.</div>;

            return (
                <div className="h-full border rounded-lg overflow-hidden bg-white">
                    <ResizablePanel
                        left={
                            <div className="h-full flex flex-col bg-gray-50">
                                <div className="p-1 border-b flex items-center space-x-2">
                                    <input
                                        type="text"
                                        placeholder={`Search ${Object.values(data.namespaces).flatMap(k => Object.values(k)).flat().length} types...`}
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full px-2 py-1 border rounded text-sm"
                                    />
                                    <label className="flex items-center space-x-1.5 text-xs text-gray-600 whitespace-nowrap">
                                        <input type="checkbox" checked={isTreeInitiallyExpanded} onChange={e => setIsTreeInitiallyExpanded(e.target.checked)} />
                                        <span>Auto-Expand</span>
                                    </label>
                                </div>
                                <div className="overflow-y-auto flex-grow">
                                    <TreeView
                                        data={treeData}
                                        onSelect={setSelectedType}
                                        initialExpanded={isTreeInitiallyExpanded || !!searchTerm}
                                    />
                                </div>
                            </div>
                        }
                        right={
                            <TypeDetail type={selectedType} />
                        }
                    />
                </div>
            );
        };
        // ===================================================================
        // ==============     IOC & APP INITIALIZATION     ===================
        // ===================================================================

        const AppWithDependencies = connectDependencies(() => {
            const panelService = useDependency(IPanelService);
            const { openPanels, activePanel } = useObservable(panelService.state$, panelService.getInitialState());

            // Setup transitions for the active panel
            const panelTransitions = useTransition(activePanel, {
                key: panel => panel?.id,
                from: { opacity: 0, transform: 'translateY(10px)' },
                enter: { opacity: 1, transform: 'translateY(0px)' },
                leave: { opacity: 0, transform: 'translateY(-10px)', position: 'absolute', top: 0, left: 0, right: 0 },
                config: { tension: 220, friction: 25 },
            });


            return (
                <div className="p-2 max-w-7xl mx-auto bg-gray-50 shadow-lg rounded-lg mt-4 flex flex-col h-[95vh]">
                    <h1 className="text-2xl font-bold text-gray-800 mb-2 text-center">Mendix Control Panel (Refactored)</h1>
                    <div className="flex border-b border-gray-300">
                        {openPanels.map(panel => (
                            <button key={panel.id} onClick={() => panelService.setActivePanel(panel.id)}
                                className={`px-3 py-1.5 text-sm font-medium border-b-2 ${panel.id === activePanel?.id ? 'border-blue-600 text-blue-700' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                {panel.title}
                            </button>
                        ))}
                    </div>
                    <div className="flex-grow p-2 bg-white relative overflow-hidden">
                        {panelTransitions((style, panel) =>
                            panel ? (
                                <animated.div style={style} className="w-full h-full">
                                    <panel.component />
                                </animated.div>
                            ) : (
                                <div className="text-center text-gray-500">No panel selected.</div>
                            )
                        )}
                    </div>
                </div>
            );
        }, [
            // --- Framework Registrations ---
            [IApiService, { useClass: ApiService }],
            [IPanelService, { useClass: PanelService }],

            // --- Business Logic Registrations (as Panels) ---
            [IPanel, { useValue: { id: 'api-explorer', title: 'API Explorer', component: ApiExplorerPanel, defaultActive: true } }],
        ]);

        const root = ReactDOM.createRoot(document.getElementById("app"));
        root.render(<AppWithDependencies />);
    </script>
</body>

</html>