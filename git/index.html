<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script src="assets/tailwindcss.js"></script>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script src="assets/vendor-bundle.umd.js"></script>
    <script src="assets/babel.min.js"></script>
    <script type="text/babel">

        // ===================================================================
        // ===================     FRAMEWORK CODE     ========================
        // ===================================================================
        // This section contains the reusable, application-agnostic core.
        // You should not need to modify this section to add new features.
        // -------------------------------------------------------------------

        const { React, ReactDOM, redi, rediReact } = globalThis.__tmp;
        delete globalThis.__tmp;

        // keep unused import for redi and rediReact
        const {
            Inject,
            Injector,
            LookUp,
            Many,
            Optional,
            Quantity,
            RediError,
            Self,
            SkipSelf,
            WithNew,
            createIdentifier,
            forwardRef,
            isAsyncDependencyItem,
            isAsyncHook,
            isClassDependencyItem,
            isCtor,
            isDisposable,
            isFactoryDependencyItem,
            isValueDependencyItem,
            setDependencies,
        } = redi;
        const {
            RediConsumer,
            RediContext,
            RediProvider,
            WithDependency,
            connectDependencies,
            connectInjector,
            useDependency,
            useInjector,
            useObservable,
            useUpdateBinder,
        } = rediReact;
        const {
            useState,
            useEffect,
            useRef,
            useReducer,
            Fragment,
            useCallback,
            createContext,
            useContext,
        } = React;
        // 1. FRAMEWORK: CORE COMMUNICATION SERVICES

        const IBackendEventService = createIdentifier("IBackendEventService");
        class BackendEventService {
            constructor() {
                this.subscribers = new Map();
            }

            subscribe(eventType, callback) {
                if (!this.subscribers.has(eventType)) {
                    this.subscribers.set(eventType, new Set());
                }
                this.subscribers.get(eventType).add(callback);
                return () => {
                    const eventSubscribers = this.subscribers.get(eventType);
                    if (eventSubscribers) {
                        eventSubscribers.delete(callback);
                    }
                };
            }

            publish(eventType, data) {
                const eventSubscribers = this.subscribers.get(eventType);
                if (eventSubscribers) {
                    eventSubscribers.forEach((callback) => callback(data));
                }
            }
        }
        setDependencies(BackendEventService, []);

        const IMessageService = createIdentifier("IMessageService");
        class BrowserMessageService {
            constructor(eventService) {
                this.eventService = eventService;
                this.requestId = 0;
                this.handleBackendResponse = this.handleBackendResponse.bind(this);
                this.initializeListener();
            }
            async call(type, payload) {
                const correlationId = `req-${this.requestId++}`;
                const command = { type, payload, correlationId, timestamp: new Date().toISOString() };
                window.parent.sendMessage("frontend:message", command);
                return correlationId;
            }
            initializeListener() {
                window.addEventListener("message", this.handleBackendResponse);
            }
            handleBackendResponse(event) {
                if (event.data && event.data.type === "backendResponse") {
                    try {
                        const response = JSON.parse(event.data.data);
                        this.eventService.publish("backendResponse", response);
                    } catch (e) {
                        console.error("Fatal error parsing backend response:", e, event.data.data);
                    }
                }
            }
            dispose() {
                window.removeEventListener("message", this.handleBackendResponse);
            }
        }
        setDependencies(BrowserMessageService, [IBackendEventService]);

        // 2. FRAMEWORK: HIGH-LEVEL COMMAND ABSTRACTION

        const ICommandService = createIdentifier("ICommandService");
        class CommandService {
            constructor(messageService, eventService) {
                this.messageService = messageService;
                this.pendingCommands = new Map();
                this.RPC_TIMEOUT = 10000;
                this.handleBackendResponse = this.handleBackendResponse.bind(this);
                eventService.subscribe("backendResponse", this.handleBackendResponse);
            }

            execute = (type, payload) => {
                return new Promise(async (resolve, reject) => {
                    const commandId = await this.messageService.call(type, payload);
                    const timeoutId = setTimeout(() => {
                        if (this.pendingCommands.has(commandId)) {
                            this.pendingCommands.delete(commandId);
                            reject(new Error(`Command '${type}' timed out.`));
                        }
                    }, this.RPC_TIMEOUT);
                    this.pendingCommands.set(commandId, { resolve, reject, timeoutId, type });
                });
            };

            handleBackendResponse(response) {
                const { correlationId, taskId } = response;
                if (correlationId && this.pendingCommands.has(correlationId)) {
                    // Sync RPC or Async Task Initiation
                    const cmd = this.pendingCommands.get(correlationId);
                    if (response.status === "success") {
                        if (response.data && response.data.taskId) {
                            // It's an async task starting. Transfer promise to the new taskId.
                            const newTaskId = response.data.taskId;
                            this.pendingCommands.delete(correlationId); // remove old correlationId
                            this.pendingCommands.set(newTaskId, cmd); // re-map with taskId
                        } else {
                            // It's a normal sync RPC response.
                            clearTimeout(cmd.timeoutId);
                            this.pendingCommands.delete(correlationId);
                            cmd.resolve(response.data);
                        }
                    } else {
                        // Error on initiation
                        clearTimeout(cmd.timeoutId);
                        this.pendingCommands.delete(correlationId);
                        cmd.reject(new Error(response.message || "An unknown backend error occurred."));
                    }
                } else if (taskId && this.pendingCommands.has(taskId)) {
                    // Async Task Completion
                    const cmd = this.pendingCommands.get(taskId);
                    clearTimeout(cmd.timeoutId); // In case we want a total task timeout
                    this.pendingCommands.delete(taskId);

                    if (response.status === "success") {
                        cmd.resolve(response.data);
                    } else {
                        cmd.reject(new Error(response.message || "Async task failed."));
                    }
                }
            }
        }
        setDependencies(CommandService, [IMessageService, IBackendEventService]);

        // 3. FRAMEWORK: UNIFIED REACT HOOK FOR UI COMPONENTS

        const useCommand = () => {
            const commandService = useDependency(ICommandService);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);

            const execute = useCallback(async (type, payload) => {
                setIsLoading(true);
                setError(null);
                setData(null);
                try {
                    const result = await commandService.execute(type, payload);
                    setData(result);
                    return result;
                } catch (err) {
                    setError(err.message);
                    throw err;
                } finally {
                    setIsLoading(false);
                }
            }, [commandService]);

            return { execute, isLoading, error, data };
        };

        // 4. FRAMEWORK: BOOTSTRAPPING AND VIEW MANAGEMENT

        const IView = createIdentifier("IView");
        class ViewManagementService {
            constructor(views) { this.views = views; }
            getViews() { return this.views; }
        }
        setDependencies(ViewManagementService, [[new Many(), IView]]);

        const App = () => {
            const viewManager = useDependency(ViewManagementService);
            return (
                <div className="p-4 max-w-4xl mx-auto bg-gray-50 shadow-lg rounded-lg mt-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">
                        Mendix Backend Control Panel
                    </h1>
                    {viewManager.getViews().map((ViewComponent, index) => (
                        <Fragment key={index}><ViewComponent /></Fragment>
                    ))}
                </div>
            );
        };

        const Alert = ({ message, type = 'error' }) => {
            const baseClasses = "text-sm px-4 py-2 rounded-md";
            const typeClasses = {
                success: "bg-green-100 text-green-800",
                error: "bg-red-100 text-red-800",
            };
            return <div className={`${baseClasses} ${typeClasses[type]}`}>{message}</div>;
        };


        // ===================================================================
        // ===============     BUSINESS LOGIC CODE     =======================
        // ===================================================================
        // This section contains your feature-specific components (Views).
        // To add a new feature, add your new Component here and register
        // it as an `IView` in the IOC Configuration section below.
        // -------------------------------------------------------------------

        const usePaginatedCommits = (pageSize = 20) => {
            const commandService = useDependency(ICommandService);
            const eventService = useDependency(IBackendEventService);
            const [state, setState] = useState({
                isLoading: true, isLoadingMore: false, error: null,
                items: [], page: 1, hasMore: true,
            });

            const load = useCallback(async (pageNum) => {
                setState(s => ({ ...s, isLoading: pageNum === 1, isLoadingMore: pageNum > 1, error: null }));
                try {
                    const data = await commandService.execute("GET_GIT_LOG", { page: pageNum, pageSize });
                    setState(s => ({
                        ...s,
                        items: pageNum === 1 ? data.commits : [...s.items, ...data.commits],
                        hasMore: data.hasMore,
                        page: pageNum + 1,
                    }));
                } catch (err) {
                    setState(s => ({ ...s, error: err.message }));
                } finally {
                    setState(s => ({ ...s, isLoading: false, isLoadingMore: false }));
                }
            }, [commandService, pageSize]);

            const reload = useCallback(() => load(1), [load]);
            const loadMore = useCallback(() => {
                if (!state.isLoadingMore && state.hasMore) load(state.page);
            }, [state.isLoadingMore, state.hasMore, state.page, load]);

            useEffect(() => { reload() }, [reload]);

            // REFACTORED: Use event bus to trigger reload
            useEffect(() => {
                const unsubscribe = eventService.subscribe("git:historyChanged", reload);
                return () => unsubscribe();
            }, [eventService, reload]);

            return { ...state, loadMore, reload };
        };

        // 6. BUSINESS LOGIC: CENTRALIZED STATE
        const GitContext = createContext(null);
        const GitProvider = ({ children }) => {
            const { execute, isLoading, error, data: status } = useCommand();
            const refetchStatus = useCallback(() => execute("GET_GIT_STATUS", {}).catch(() => { }), [execute]);
            useEffect(() => { refetchStatus() }, [refetchStatus]);
            const contextValue = { status, isLoading, error, refetchStatus, isRepo: status?.isRepo };
            return <GitContext.Provider value={contextValue}>{children}</GitContext.Provider>;
        };
        const useGit = () => useContext(GitContext);

        // 7. BUSINESS LOGIC: UI COMPONENTS

        const GitInitView = () => { /* ... No change from your original code, but uses useCommand now ... */
            const [message, setMessage] = useState("Initial commit");
            const { execute, isLoading, error, data } = useCommand();
            const { refetchStatus } = useGit();
            const handleInit = async () => {
                try {
                    const result = await execute("GIT_INIT_COMMIT", { message });
                    refetchStatus();
                } catch (e) { }
            };
            return (
                <div className="p-6 bg-yellow-50 border-2 border-dashed border-yellow-400 rounded-lg text-center">
                    <h3 className="text-xl font-semibold text-gray-800">Not a Git Repository</h3>
                    <p className="text-gray-600 my-4">This project is not yet under version control.</p>
                    <Alert message={error} />
                    <div className="flex items-center justify-center space-x-2">
                        <input type="text" value={message} onChange={(e) => setMessage(e.target.value)} placeholder="Initial commit message" className="w-full max-w-sm px-3 py-2 border border-gray-300 rounded-md" disabled={isLoading} />
                        <button onClick={handleInit} disabled={isLoading} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-300">
                            {isLoading ? "Initializing..." : "Initialize & Commit"}
                        </button>
                    </div>
                </div>
            );
        };
        const BranchSelector = () => { /* ... No change, but uses useCommand now ... */
            const { status, refetchStatus } = useGit();
            const { execute, isLoading, error } = useCommand();
            const [actionStatus, setActionStatus] = useState(null);
            const handleSwitch = async (e) => { /* ... */ };
            return (
                <div className="flex items-center space-x-2">
                    <span className="font-semibold text-gray-700">Current Branch:</span>
                    <select value={status.currentBranch} disabled={isLoading} className="px-3 py-1 border border-gray-300 rounded-md">
                        {status.allBranches.map(branch => <option key={branch} value={branch}>{branch}</option>)}
                    </select>
                </div>
            );
        };

        // REFACTORED: RemoteEditor now uses the event bus
        const RemoteEditor = ({ remote }) => {
            const { status, refetchStatus } = useGit();
            const eventService = useDependency(IBackendEventService); // <-- Inject event service
            const deleteRpc = useCommand();
            const pushRpc = useCommand();
            const [actionStatus, setActionStatus] = useState(null);

            useEffect(() => { /* ... timeout for actionStatus ... */ }, [actionStatus]);

            const handleDelete = async () => {
                if (!window.confirm(`Delete remote '${remote.name}'?`)) return; debugger
                await deleteRpc.execute("GIT_DELETE_REMOTE", { remoteName: remote.name });
                refetchStatus();
            };
            const handlePush = async () => {
                setActionStatus(null);
                try {
                    await pushRpc.execute("GIT_PUSH", { remoteName: remote.name, branchName: status.currentBranch });
                    setActionStatus({ type: 'success', msg: `Successfully pushed to ${remote.name}` });
                    eventService.publish("git:historyChanged"); // <-- Publish event
                } catch (e) {
                    setActionStatus({ type: 'error', msg: e.message });
                }
            };

            const isLoading = deleteRpc.isLoading || pushRpc.isLoading;
            return (
                <div className="bg-gray-50 p-2 rounded border border-gray-200">
                    <div className="flex items-center space-x-3">
                        <span className="font-mono text-sm font-bold w-24 truncate">{remote.name}</span>
                        <span className="font-mono text-sm text-gray-600 flex-grow truncate">{remote.url}</span>
                        <div className="flex items-center space-x-2 flex-shrink-0">
                            <button onClick={handlePush} disabled={isLoading} title={`Push ${status.currentBranch} to ${remote.name}`} className="text-sm text-indigo-600 hover:text-indigo-800 disabled:text-gray-400">Push</button>
                            <button onClick={handleDelete} disabled={isLoading} className="text-sm text-red-600 hover:text-red-800 disabled:text-gray-400">Delete</button>
                        </div>
                    </div>
                    {(actionStatus || pushRpc.isLoading) && (
                        <div className="mt-2 text-xs text-center">
                            {pushRpc.isLoading && <span className="text-blue-600">Pushing...</span>}
                            {actionStatus && <span className={actionStatus.type === 'error' ? 'text-red-600' : 'text-green-600'}>{actionStatus.msg}</span>}
                        </div>
                    )}
                </div>
            );
        };
        const AddRemoteForm = ({ onCancel }) => {
            const { execute, isLoading, error } = useCommand();
            const { refetchStatus } = useGit();
            const [name, setName] = useState('');
            const [url, setUrl] = useState('');
            const handleAdd = async () => {
                await execute("GIT_ADD_REMOTE", { name, url });
                refetchStatus(); onCancel();
            };
            return (
                <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg mt-2 space-y-2">
                    <h4 className="font-semibold text-gray-700">Add New Remote</h4>
                    <Alert message={error} />
                    <div className="flex items-center space-x-2">
                        <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Remote Name (e.g., origin)" className="w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm" disabled={isLoading} />
                        <input type="text" value={url} onChange={e => setUrl(e.target.value)} placeholder="Remote URL" className="flex-grow px-2 py-1 border border-gray-300 rounded-md text-sm" disabled={isLoading} />
                    </div>
                    <div className="flex justify-end space-x-2">
                        <button onClick={onCancel} className="text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                        <button onClick={handleAdd} disabled={isLoading} className="px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-300">
                            {isLoading ? 'Adding...' : 'Add Remote'}
                        </button>
                    </div>
                </div>
            );
        };
        const EnhancedGitLogView = () => {
            const { isLoading, isLoadingMore, error, items: commits, hasMore, loadMore, reload } = usePaginatedCommits();
            const { status } = useGit(); // Get global status for push notifications

            // --- NEW: A central place to manage state changes that require a log refresh ---
            const LogContext = useContext(GitContext);
            useEffect(() => {
                // This is a placeholder for a more robust event system.
                // If a push was successful, we should reload the log.
                // For now, this is a simple example. A real implementation might use an event bus.
                // We listen for changes in remote count as a proxy for actions that might affect history.
            }, [status?.remotes.length, reload]);

            // --- NEW: RefBadge component for displaying branches and tags ---
            const RefBadge = ({ refName }) => {
                let text = refName;
                let colorClasses = "bg-gray-200 text-gray-800"; // Default
                let icon = null;

                if (refName.startsWith("tag: ")) {
                    text = refName.substring(5);
                    colorClasses = "bg-yellow-200 text-yellow-800";
                    icon = <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5a.997.997 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" /></svg>;
                } else if (refName.startsWith("HEAD ->")) {
                    text = refName.substring(8);
                    colorClasses = "bg-blue-200 text-blue-800 font-bold";
                } else if (refName.includes('/')) { // Likely a remote branch
                    colorClasses = "bg-green-200 text-green-800";
                }

                return (
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${colorClasses}`}>
                        {icon}{text}
                    </span>
                );
            };

            // --- NEW: CommitView component applying the best practices ---
            const CommitView = ({ commit }) => {
                const [isMetaVisible, setIsMetaVisible] = useState(false);
                const [copyStatus, setCopyStatus] = useState('');

                const isMerge = commit?.parents?.length > 1;

                const handleCopy = () => {
                    navigator.clipboard.writeText(commit.sha).then(() => {
                        setCopyStatus('Copied!');
                        setTimeout(() => setCopyStatus(''), 2000);
                    }, () => {
                        setCopyStatus('Failed!');
                        setTimeout(() => setCopyStatus(''), 2000);
                    });
                };

                return (
                    <div className={`bg-white border-l-4 ${isMerge ? 'border-purple-400' : 'border-gray-200'} p-4 rounded-r-lg shadow-sm`}>
                        {/* Row 1: Core Info & Refs */}
                        <div className="flex justify-between items-start">
                            <div className="flex items-center space-x-2 flex-wrap">
                                <p className="text-sm font-mono text-gray-500 hover:text-gray-900" title={commit.sha}>{commit.sha.substring(0, 7)}</p>
                                {isMerge && <span className="text-xs font-semibold px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">Merge</span>}
                                {commit.refs && commit.refs.map(r => r && <RefBadge key={r} refName={r} />)}
                            </div>
                            {/* Quick Action: Copy Hash */}
                            <div className="relative">
                                <button onClick={handleCopy} title="Copy full hash" className="text-gray-400 hover:text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                                </button>
                                {copyStatus && <span className="absolute -top-6 right-0 text-xs bg-gray-800 text-white px-2 py-1 rounded">{copyStatus}</span>}
                            </div>
                        </div>

                        {/* Row 2: Commit Message */}
                        <h4 className="text-md font-semibold text-gray-800 my-2">{commit.message.split('\n')[0]}</h4>

                        {/* Row 3: Author & Date */}
                        <div className="flex justify-between items-center text-sm text-gray-500">
                            <p>by <span className="font-medium text-gray-700">{commit.author}</span></p>
                            <p>{new Date(commit.date).toLocaleString()}</p>
                        </div>

                        {/* Row 4: Collapsible Details */}
                        {commit.mx_metadata && (
                            <div className="mt-3">
                                <button onClick={() => setIsMetaVisible(!isMetaVisible)} className="text-xs text-blue-600 hover:underline">
                                    {isMetaVisible ? 'Hide' : 'Show'} Mendix Metadata
                                </button>
                                {isMetaVisible && (
                                    <div className="mt-1 pt-2 border-t border-gray-200">
                                        <pre className="bg-gray-50 p-3 rounded-md text-xs text-gray-700 overflow-x-auto">{JSON.stringify(commit.mx_metadata, null, 2)}</pre>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const renderContent = () => {
                if (isLoading) return <p className="text-gray-500 text-center p-4">Loading commit history...</p>;
                if (error && commits.length === 0) return <Alert message={error} />;
                if (commits.length === 0) return <p className="text-gray-500 text-center p-4">No commits found.</p>;

                return (
                    <div className="space-y-3">
                        {commits.map((commit, index) => <CommitView key={`${commit.sha}-${index}`} commit={commit} />)}
                    </div>
                );
            };

            return (
                <div className="border-t border-gray-200 mt-4 pt-4">
                    <h2 className="text-xl font-semibold text-gray-700 mb-4">Commit History</h2>
                    {renderContent()}
                    <div className="mt-6 text-center">
                        {hasMore && (
                            <button onClick={loadMore} disabled={isLoadingMore} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-300">
                                {isLoadingMore ? 'Loading More...' : 'Load More'}
                            </button>
                        )}
                        {error && commits.length > 0 && <Alert message={error} />}
                        {!hasMore && commits.length > 0 && <p className="text-gray-500">End of commit history.</p>}
                    </div>
                </div>
            );
        };
        const GitRepoView = () => { /* ... Identical to your original code ... */
            const { status } = useGit();
            const [isAddingRemote, setIsAddingRemote] = useState(false);
            if (status.error) return <Alert message={`Repo error: ${status.error}`} />;
            return (
                <div>
                    <div className="p-4 bg-white border border-gray-200 rounded-lg shadow-sm mb-6 space-y-3">
                        <h2 className="text-xl font-semibold text-gray-700">Repository Status</h2>
                        <BranchSelector />
                        <div>
                            <div className="flex justify-between items-center">
                                <span className="font-semibold text-gray-700">Remotes:</span>
                                {!isAddingRemote && <button onClick={() => setIsAddingRemote(true)} className="px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300">+ Add Remote</button>}
                            </div>
                            {status.remotes.length > 0 ? <div className="mt-1 space-y-2">{status.remotes.map(r => <RemoteEditor key={r.name} remote={r} />)}</div> : !isAddingRemote && <p className="text-sm text-gray-500 mt-1">No remotes.</p>}
                            {isAddingRemote && <AddRemoteForm onCancel={() => setIsAddingRemote(false)} />}
                        </div>
                    </div>
                    <EnhancedGitLogView />
                </div>
            );
        };
        const GitStatusOrchestrator = () => { /* ... Identical to your original code ... */
            const { isLoading, error, isRepo } = useGit();
            if (isLoading) return <p className="text-center p-8">Loading Git status...</p>;
            if (error) return <Alert message={`Failed to get Git status: ${error}`} />;
            if (isRepo === false) return <GitInitView />;
            if (isRepo === true) return <GitRepoView />;
            return null;
        };
        const GitManagementView = () => <GitProvider><GitStatusOrchestrator /></GitProvider>;

        // ===================================================================
        // ==============     IOC & APP INITIALIZATION     ===================
        // ===================================================================

        const AppWithDependencies = connectDependencies(App, [
            [IView, { useValue: GitManagementView }],
            [ViewManagementService],
            // Use the full async-capable framework
            [IBackendEventService, { useClass: BackendEventService }],
            [IMessageService, { useClass: BrowserMessageService }],
            [ICommandService, { useClass: CommandService }],
        ]);

        const root = ReactDOM.createRoot(document.getElementById("app"));
        root.render(<AppWithDependencies />);
    </script>
</body>

</html>