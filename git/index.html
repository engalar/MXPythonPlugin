<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script src="assets/tailwindcss.js"></script>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script src="assets/vendor-bundle.umd.js"></script>
    <script src="assets/babel.min.js"></script>
    <script type="text/babel">

        // ===================================================================
        // ===================     FRAMEWORK CODE     ========================
        // ===================================================================
        // This section contains the reusable, application-agnostic core.
        // You should not need to modify this section to add new features.
        // -------------------------------------------------------------------
        // 等价于
        // import * as React from 'react';
        // import ReactDOM from 'react-dom/client';
        // import * as redi from '@wendellhu/redi';
        // import * as rediReact from '@wendellhu/redi/react-bindings';
        // import * as rxjs from 'rxjs';
        // import * as reactSpring from '@react-spring/web';
        const { React, ReactDOM, redi, rediReact, rxjs, reactSpring } = globalThis.__tmp;
        delete globalThis.__tmp;

        // keep unused import for redi and rediReact
        const {
            Inject,
            Injector,
            LookUp,
            Many,
            Optional,
            Quantity,
            RediError,
            Self,
            SkipSelf,
            WithNew,
            createIdentifier,
            forwardRef,
            isAsyncDependencyItem,
            isAsyncHook,
            isClassDependencyItem,
            isCtor,
            isDisposable,
            isFactoryDependencyItem,
            isValueDependencyItem,
            setDependencies,
        } = redi;
        const {
            RediConsumer,
            RediContext,
            RediProvider,
            WithDependency,
            connectDependencies,
            connectInjector,
            useDependency,
            useInjector,
            useObservable,
            useUpdateBinder,
        } = rediReact;
        const {
            useState,
            useEffect,
            useRef,
            useReducer,
            Fragment,
            useCallback,
            createContext,
            useContext,
        } = React;
        const { BehaviorSubject, Subject, fromEvent, map, filter } = rxjs;
        const { useSpring, useTransition, animated } = reactSpring;

        // 1. FRAMEWORK: CORE COMMUNICATION SERVICES


        const IApiService = createIdentifier('IApiService');

        class ApiService {
            constructor() {
                this.reqIdCounter = 0;
                this.pendingRpcs = new Map();
                this.activeJobs = new Map();
                this.activeSessions = new Map();
                this.broadcastChannels = new Map();

                fromEvent(window, 'message')
                    .pipe(filter(event => event.data && event.data.type === 'backendResponse'))
                    .pipe(map(event => JSON.parse(event.data.data)))
                    .subscribe(msg => this._handleBackendMessage(msg));
            }

            // --- Public Methods for Hooks ---

            rpc(method, params) {
                return new Promise((resolve, reject) => {
                    const reqId = `req-${this.reqIdCounter++}`;
                    this.pendingRpcs.set(reqId, { resolve, reject });
                    this._sendMessage({ type: 'RPC', reqId, method, params });
                    setTimeout(() => {
                        if (this.pendingRpcs.has(reqId)) {
                            this.pendingRpcs.delete(reqId);
                            reject(new Error(`RPC call '${method}' timed out.`));
                        }
                    }, 10000);
                });
            }

            startJob(method, params) {
                const subject = new Subject();
                const reqId = `req-${this.reqIdCounter++}`;

                const promise = new Promise((resolve, reject) => {
                    this.pendingRpcs.set(reqId, {
                        resolve: ({ jobId }) => {
                            this.activeJobs.set(jobId, subject);
                            resolve({ jobId }); // Resolve promise with jobId once started
                        },
                        reject
                    });
                });

                this._sendMessage({ type: 'JOB_START', reqId, method, params });
                return { startPromise: promise, updates$: subject.asObservable() };
            }

            connectSession(channel, payload) {
                const sessionId = `${channel}-${Math.random().toString(36).substr(2, 9)}`;
                if (!this.activeSessions.has(sessionId)) {
                    const subject = new Subject();
                    this.activeSessions.set(sessionId, subject);
                    this._sendMessage({ type: 'SESSION_CONNECT', sessionId, channel, payload });
                }
                return { sessionId, messages$: this.activeSessions.get(sessionId).asObservable() };
            }

            disconnectSession(sessionId, channel) {
                if (this.activeSessions.has(sessionId)) {
                    this.activeSessions.get(sessionId).complete();
                    this.activeSessions.delete(sessionId);
                    this._sendMessage({ type: 'SESSION_DISCONNECT', sessionId, channel });
                }
            }

            subscribeBroadcast(channel) {
                if (!this.broadcastChannels.has(channel)) {
                    this.broadcastChannels.set(channel, new Subject());
                }
                return this.broadcastChannels.get(channel).asObservable();
            }

            // --- Internal Message Handling ---

            _sendMessage(data) {
                window.parent.sendMessage('frontend:message', data);
            }

            _handleBackendMessage(msg) {
                const { type, reqId, jobId, sessionId, channel } = msg;

                switch (type) {
                    case 'RPC_SUCCESS':
                        this.pendingRpcs.get(reqId)?.resolve(msg.data);
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'RPC_ERROR':
                        this.pendingRpcs.get(reqId)?.reject({ message: msg.message, traceback: msg.traceback });
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'JOB_STARTED':
                        this.pendingRpcs.get(reqId)?.resolve({ jobId });
                        this.pendingRpcs.delete(reqId);
                        break;
                    case 'JOB_PROGRESS':
                        this.activeJobs.get(jobId)?.next({ type: 'progress', ...msg });
                        break;
                    case 'JOB_SUCCESS':
                        this.activeJobs.get(jobId)?.next({ type: 'success', ...msg });
                        this.activeJobs.get(jobId)?.complete();
                        this.activeJobs.delete(jobId);
                        break;
                    case 'JOB_ERROR':
                        this.activeJobs.get(jobId)?.next({ type: 'error', ...msg });
                        this.activeJobs.get(jobId)?.complete();
                        this.activeJobs.delete(jobId);
                        break;
                    case 'EVENT_BROADCAST':
                        this.broadcastChannels.get(channel)?.next(msg.data);
                        break;
                    case 'EVENT_SESSION':
                        this.activeSessions.get(sessionId)?.next(msg.data);
                        break;
                }
            }
        }
        setDependencies(ApiService, []);

        // --- High-Level React Hooks (Simplifying Boilerplate) ---

        function useRpc(method) {
            const api = useDependency(IApiService);
            const [state, setState] = useState({ isLoading: false, data: null, error: null });

            const execute = useCallback(async (params) => {
                setState({ isLoading: true, data: null, error: null });
                try {
                    const result = await api.rpc(method, params);
                    setState({ isLoading: false, data: result, error: null });
                    return result;
                } catch (err) {
                    setState({ isLoading: false, data: null, error: err });
                    throw err;
                }
            }, [api, method]);
            return { ...state, execute };
        }

        const initialJobState = { status: 'idle', progress: { percent: 0, message: '' }, data: null, error: null };
        function useJob(method) {
            const api = useDependency(IApiService);
            const [state, setState] = useState(initialJobState);
            const subRef = useRef(null);

            const start = useCallback((params) => {
                setState({ ...initialJobState, status: 'starting' });
                const { startPromise, updates$ } = api.startJob(method, params);

                startPromise.then(({ jobId }) => {
                    subRef.current = updates$.subscribe({
                        next: (update) => {
                            if (update.type === "JOB_PROGRESS") setState(s => ({ ...s, status: 'running', progress: update.progress }));
                            else if (update.type === "JOB_SUCCESS") setState(s => {
                                s.progress.percent = 100;
                                return { ...s, status: 'success', data: update.data };
                            })
                            else if (update.type === 'JOB_ERROR') setState(s => ({ ...s, status: 'error', error: { message: update.message, traceback: update.traceback } }));
                        },
                        error: (err) => setState(s => ({ ...s, status: 'error', error: err })),
                        complete: () => {
                            // Handled by success/error messages
                        }
                    });
                }).catch(err => {
                    setState({ ...initialJobState, status: 'error', error: err });
                });
            }, [api, method]);

            useEffect(() => {
                // Cleanup subscription on unmount
                return () => subRef.current?.unsubscribe();
            }, []);

            return { ...state, start };
        }

        function usePush(channel, options = {}) {
            const api = useDependency(IApiService);
            const [latestMessage, setLatestMessage] = useState(null);

            useEffect(() => {
                let sub;
                let sessionId;

                if (options.isSession) {
                    const session = api.connectSession(channel, options.payload);
                    sessionId = session.sessionId;
                    sub = session.messages$.subscribe(setLatestMessage);
                } else {
                    sub = api.subscribeBroadcast(channel).subscribe(setLatestMessage);
                }

                return () => {
                    sub?.unsubscribe();
                    if (sessionId) {
                        api.disconnectSession(sessionId, channel);
                    }
                };
            }, [api, channel, options.isSession, JSON.stringify(options.payload)]); // re-run if payload changes

            return { latestMessage };
        }

        // 2. REFACTORED: Panel Service powered by RxJS
        const IPanel = createIdentifier("IPanel");
        const IPanelService = createIdentifier("IPanelService");
        class PanelService {
            constructor(panels) {
                this.allPanels = new Map(panels.map(p => [p.id, p]));

                // Internal state managed by a BehaviorSubject
                this._state$ = new BehaviorSubject(this.getInitialState());

                // Publicly exposed observable stream of the state
                this.state$ = this._state$.asObservable();
            }

            getInitialState() {
                const initialOpenIds = new Set(
                    Array.from(this.allPanels.values())
                        .filter(p => p.defaultActive)
                        .map(p => p.id)
                );
                const initialActiveId = Array.from(this.allPanels.values())
                    .find(p => p.defaultActive)?.id || null;
                return this._computeState(initialOpenIds, initialActiveId);
            }

            // Private method to compute the full state object from IDs
            _computeState(openPanelIds, activePanelId) {
                const openPanels = Array.from(openPanelIds)
                    .map(id => this.allPanels.get(id))
                    .filter(Boolean); // Filter out potential undefineds
                const activePanel = activePanelId ? this.allPanels.get(activePanelId) : null;

                return { openPanels, activePanel };
            }

            // Private method to update the stream
            _updateState(newOpenIds, newActiveId) {
                const newState = this._computeState(newOpenIds, newActiveId);
                this._state$.next(newState);
            }

            // --- Public API for Panel Control ---
            openPanel(id) {
                if (!this.allPanels.has(id)) return;

                const currentState = this._state$.getValue();
                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));

                if (currentOpenIds.has(id)) {
                    this.setActivePanel(id);
                    return;
                }

                currentOpenIds.add(id);
                this._updateState(currentOpenIds, id);
            }

            closePanel(id) {
                const currentState = this._state$.getValue();
                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));
                if (!currentOpenIds.has(id)) return;

                currentOpenIds.delete(id);
                let newActiveId = currentState.activePanel?.id;
                if (newActiveId === id) {
                    newActiveId = currentOpenIds.values().next().value || null;
                }
                this._updateState(currentOpenIds, newActiveId);
            }

            setActivePanel(id) {
                const currentState = this._state$.getValue();
                if (currentState.activePanel?.id === id) return;

                const currentOpenIds = new Set(currentState.openPanels.map(p => p.id));
                if (!currentOpenIds.has(id)) return; // Can't activate a panel that isn't open

                this._updateState(currentOpenIds, id);
            }
        }
        setDependencies(PanelService, [[new Many(), IPanel]]);

        // 3. REFACTORED: The App Shell Component, now a pure projection of state
        const AppShell = () => {
            const panelService = useDependency(IPanelService);

            // Subscribe to the state stream.
            const { openPanels, activePanel } = useObservable(
                panelService.state$,
                panelService.getInitialState()
            );

            // Setup transitions for the active panel
            const panelTransitions = useTransition(activePanel, {
                key: panel => panel?.id,
                from: { opacity: 0, transform: 'translateY(10px)' },
                enter: { opacity: 1, transform: 'translateY(0px)' },
                leave: { opacity: 0, transform: 'translateY(-10px)', position: 'absolute', top: 0, left: 0, right: 0 },
                config: { tension: 220, friction: 25 },
            });

            return (
                <div className="p-4 max-w-5xl mx-auto bg-gray-50 shadow-lg rounded-lg flex flex-col h-[100vh]">
                    <div className="flex border-b border-gray-300">
                        {openPanels.map(panel => (
                            <button
                                key={panel.id}
                                onClick={() => panelService.setActivePanel(panel.id)}
                                className={`px-4 py-2 text-sm font-medium border-b-2 ${panel.id === activePanel?.id ? 'border-purple-600 text-purple-700' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                {panel.title}
                            </button>
                        ))}
                    </div>
                    <div className="flex-grow p-4 bg-white relative overflow-hidden">
                        {panelTransitions((style, panel) =>
                            panel ? (
                                <animated.div style={style} className="w-full h-full">
                                    <panel.component />
                                </animated.div>
                            ) : (
                                <div className="text-center text-gray-500">No panel selected.</div>
                            )
                        )}
                    </div>
                </div>
            );
        };

        const Alert = ({ message, type, style }) => {
            const baseClasses = "text-sm px-4 py-2 rounded-md";
            const typeClasses = {
                success: "bg-green-100 text-green-800",
                error: "bg-red-100 text-red-800",
            };
            return <animated.div style={style} className={`${baseClasses} ${typeClasses[type]}`}>{message}</animated.div>;
        };
        const ErrorDisplay = ({ error }) => {
            if (!error) return null;
            const [showTraceback, setShowTraceback] = useState(false);

            return (
                <div className="mt-4 p-3 bg-red-100 text-red-800 rounded-lg border border-red-200">
                    <div className="flex justify-between items-center">
                        <p className="font-semibold break-all">Error: {error.message}</p>
                        {error.traceback && (
                            <button
                                onClick={() => setShowTraceback(!showTraceback)}
                                className="text-xs text-red-600 hover:text-red-800 font-medium ml-4 flex-shrink-0"
                            >
                                {showTraceback ? 'Hide Details' : 'Show Details'}
                            </button>
                        )}
                    </div>
                    {showTraceback && error.traceback && (
                        <pre className="mt-3 p-2 bg-red-50 text-xs text-red-900 overflow-auto rounded font-mono">
                            <code>{error.traceback}</code>
                        </pre>
                    )}
                </div>
            );
        };

        // ===================================================================
        // ===============     BUSINESS LOGIC CODE     =======================
        // ===================================================================
        // This section contains your feature-specific components (Views).
        // To add a new feature, add your new Component here and register
        // it as an `IView` in the IOC Configuration section below.
        // -------------------------------------------------------------------

        const GitInitView = ({ onInitialized }) => {
            const [message, setMessage] = useState("Initial commit");
            const { status, progress, data, error, start } = useJob('git:init');
            const isRunning = status === 'starting' || status === 'running';

            useEffect(() => {
                if (status === 'success') {
                    onInitialized();
                }
            }, [status, onInitialized]);

            return (
                <div className="p-6 bg-yellow-50 border-2 border-dashed border-yellow-400 rounded-lg text-center max-w-2xl mx-auto">
                    <h3 className="text-xl font-semibold text-gray-800">No Git Repository Found</h3>
                    <p className="text-gray-600 my-4">This project is not yet under version control. Initialize a repository to start tracking changes.</p>

                    <div className="flex items-center justify-center space-x-2">
                        <input
                            type="text"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder="Initial commit message"
                            className="w-full max-w-sm px-3 py-2 border border-gray-300 rounded-md"
                            disabled={isRunning}
                        />
                        <button
                            onClick={() => start({ message })}
                            disabled={isRunning}
                            className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-300 w-48"
                        >
                            {isRunning ? 'Initializing...' : 'Initialize & Commit'}
                        </button>
                    </div>
                    {isRunning && <DiffProgressDisplay progress={progress} status={status} />}
                    {error && <ErrorDisplay error={error} />}
                </div>
            );
        };

        const RemoteEditor = ({ remote, currentBranch, onUpdate }) => {
            const { execute: deleteRemote, isLoading: isDeleting } = useRpc('git:deleteRemote');
            const { start: push, status: pushStatus, progress: pushProgress, error: pushError } = useJob('git:push');
            const isPushing = pushStatus === 'starting' || pushStatus === 'running';
            const isLoading = isDeleting || isPushing;

            const handleDelete = async () => {
                if (window.confirm(`Are you sure you want to delete the remote '${remote.name}'?`)) {
                    await deleteRemote({ remoteName: remote.name });
                    onUpdate();
                }
            };

            const handlePush = () => {
                push({ remoteName: remote.name, branchName: currentBranch });
            };

            return (
                <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div className="flex items-center space-x-3">
                        <span className="font-mono text-sm font-bold w-24 truncate">{remote.name}</span>
                        <span className="font-mono text-sm text-gray-600 flex-grow truncate">{remote.url}</span>
                        <div className="flex items-center space-x-2 flex-shrink-0">
                            <button onClick={handlePush} disabled={isLoading} title={`Push ${currentBranch} to ${remote.name}`} className="text-sm px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 disabled:bg-gray-300">Push</button>
                            <button onClick={handleDelete} disabled={isLoading} className="text-sm text-red-600 hover:text-red-800 disabled:text-gray-400">Delete</button>
                        </div>
                    </div>
                    {isPushing && <DiffProgressDisplay progress={pushProgress} status={pushStatus} />}
                    {pushError && <ErrorDisplay error={pushError} />}
                </div>
            );
        };

        const DiffControlPanel = ({ selected, onCompare, onClear, isLoading }) => {
            const canCompare = selected.a && selected.b;
            return (
                <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4 sticky top-0 z-10 shadow-sm">
                    <div className="flex justify-between items-center">
                        <div className="flex-grow space-y-1">
                            <div className="flex items-center">
                                <span className="font-bold text-blue-800 w-4">A:</span>
                                {selected.a ? <span className="font-mono text-sm text-gray-700">{selected.a.sha.substring(0, 7)} - {selected.a.message.split('\n')[0]}</span> : <span className="text-gray-500 text-sm">Select a base commit from the list below.</span>}
                            </div>
                            <div className="flex items-center">
                                <span className="font-bold text-green-800 w-4">B:</span>
                                {selected.b ? <span className="font-mono text-sm text-gray-700">{selected.b.sha.substring(0, 7)} - {selected.b.message.split('\n')[0]}</span> : <span className="text-gray-500 text-sm">Select a commit to compare.</span>}
                            </div>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button onClick={onClear} className="text-sm text-gray-600 hover:text-gray-800">Clear</button>
                            <button onClick={onCompare} disabled={!canCompare || isLoading} className="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-green-300">
                                {isLoading ? 'Comparing...' : 'Compare A vs B'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddRemoteForm = ({ onCancel, onAdded }) => {
            const { execute, isLoading, error } = useRpc('git:addRemote');
            const [name, setName] = useState('');
            const [url, setUrl] = useState('');

            const handleAdd = async (e) => {
                e.preventDefault();
                try {
                    await execute({ name, url });
                    onAdded();
                } catch (e) { /* error is handled by the hook */ }
            };

            return (
                <form onSubmit={handleAdd} className="p-3 bg-blue-50 border border-blue-200 rounded-lg mt-2 space-y-2">
                    <h4 className="font-semibold text-gray-700">Add New Remote</h4>
                    {error && <ErrorDisplay error={error} />}
                    <div className="flex items-center space-x-2">
                        <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Remote Name (e.g., origin)" className="w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm" disabled={isLoading} required />
                        <input type="text" value={url} onChange={e => setUrl(e.target.value)} placeholder="Remote URL" className="flex-grow px-2 py-1 border border-gray-300 rounded-md text-sm" disabled={isLoading} required />
                    </div>
                    <div className="flex justify-end space-x-2">
                        <button type="button" onClick={onCancel} className="text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" disabled={isLoading} className="px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-300">
                            {isLoading ? 'Adding...' : 'Add Remote'}
                        </button>
                    </div>
                </form>
            );
        };

        const RepoStatusView = ({ status, onUpdate }) => {
            const [isAddingRemote, setIsAddingRemote] = useState(false);
            return (
                <div className="p-4 bg-white border border-gray-200 rounded-lg shadow-sm mb-6 space-y-4">
                    <h3 className="text-lg font-semibold text-gray-700">Repository Status</h3>
                    <div className="flex items-center space-x-2">
                        <span className="font-semibold text-gray-700">Current Branch:</span>
                        <select value={status.currentBranch} className="px-3 py-1 border border-gray-300 rounded-md bg-gray-50">
                            {status.allBranches.map(branch => <option key={branch} value={branch}>{branch}</option>)}
                        </select>
                    </div>
                    <div>
                        <div className="flex justify-between items-center">
                            <span className="font-semibold text-gray-700">Remotes:</span>
                            {!isAddingRemote && <button onClick={() => setIsAddingRemote(true)} className="px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300">+ Add Remote</button>}
                        </div>
                        {status.remotes.length > 0 ? (
                            <div className="mt-1 space-y-2">
                                {status.remotes.map(r => <RemoteEditor key={r.name} remote={r} currentBranch={status.currentBranch} onUpdate={onUpdate} />)}
                            </div>
                        ) : !isAddingRemote && <p className="text-sm text-gray-500 mt-1">No remotes configured.</p>}
                        {isAddingRemote && <AddRemoteForm onCancel={() => setIsAddingRemote(false)} onAdded={() => { setIsAddingRemote(false); onUpdate(); }} />}
                    </div>
                </div>
            );
        };

        const RepoManagementPanel = () => {
            const { isLoading, data: status, error, execute: fetchStatus } = useRpc('git:getStatus');

            useEffect(() => {
                fetchStatus();
            }, []);

            if (isLoading) return <div className="text-center p-8 text-gray-500">Loading Git status...</div>;
            if (error) return <ErrorDisplay error={error} />;

            if (status) {
                if (!status.isRepo) {
                    return <GitInitView onInitialized={fetchStatus} />;
                } else {
                    return <RepoStatusView status={status} onUpdate={fetchStatus} />;
                }
            }

            return null;
        };
        const DiffProgressDisplay = ({ progress, status }) => {
            const isRunning = status === 'starting' || status === 'running';
            if (!isRunning) return null;

            const { percent, message, stage } = progress;

            return (
                <div className="mt-4 p-4 border border-blue-200 rounded-lg bg-blue-50 shadow-inner">
                    <div className="flex justify-between items-center mb-2">
                        <span className="font-semibold text-blue-800">{stage || 'Progress'}</span>
                        <span className="text-sm font-mono text-blue-600">{percent.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-blue-100 rounded-full h-3 overflow-hidden">
                        <div
                            className="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-in-out"
                            style={{ width: `${percent}%` }}
                        />
                    </div>
                    <p className="text-center text-sm text-blue-700 mt-2">{message}</p>
                </div>
            );
        };
        const RefBadge = ({ refName }) => {
                let text = refName; let colorClasses = "bg-gray-200 text-gray-800"; let icon = null;
                if (refName.startsWith("tag: ")) { text = refName.substring(5); colorClasses = "bg-yellow-200 text-yellow-800"; icon = <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5a.997.997 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" /></svg>; } else if (refName.startsWith("HEAD ->")) { text = refName.substring(8); colorClasses = "bg-blue-200 text-blue-800 font-bold"; } else if (refName.includes('/')) { colorClasses = "bg-green-200 text-green-800"; }
                return <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${colorClasses}`}>{icon}{text}</span>;
            };
        const CommitView = ({ commit, onSelect, selection }) => {
            const [isMetaVisible, setIsMetaVisible] = useState(false);
            const [copyStatus, setCopyStatus] = useState('');
            const isMerge = commit?.parents?.length > 1;
            const isSelectedA = selection.a?.sha === commit.sha;
            const isSelectedB = selection.b?.sha === commit.sha;
            let borderClass = 'border-gray-200';
            if (isSelectedA) borderClass = 'border-blue-500 ring-2 ring-blue-300';
            if (isSelectedB) borderClass = 'border-green-500 ring-2 ring-green-300';

            const handleCopy = () => { navigator.clipboard.writeText(commit.sha).then(() => { setCopyStatus('Copied!'); setTimeout(() => setCopyStatus(''), 2000); }); };

            return (
                <div className={`bg-white border-l-4 ${isMerge ? 'border-purple-400' : ''} p-4 rounded-r-lg shadow-sm transition-all ${borderClass}`}>
                    <div className="flex justify-between items-start">
                        <div className="flex items-center space-x-2 flex-wrap">
                            <p className="text-sm font-mono text-gray-500 hover:text-gray-900" title={commit.sha}>{commit.sha.substring(0, 7)}</p>
                            {isMerge && <span className="text-xs font-semibold px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">Merge</span>}
                            {commit.refs && commit.refs.map(r => r && <RefBadge key={r} refName={r} />)}
                        </div>
                        <div className="relative"><button onClick={handleCopy} title="Copy full hash" className="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>{copyStatus && <span className="absolute -top-6 right-0 text-xs bg-gray-800 text-white px-2 py-1 rounded">{copyStatus}</span>}</div>
                    </div>
                    <h4 className="text-md font-semibold text-gray-800 my-2">{commit.message.split('\n')[0]}</h4>
                    <div className="flex justify-between items-center text-sm text-gray-500">
                        <p>by <span className="font-medium text-gray-700">{commit.author}</span></p><p>{new Date(commit.date).toLocaleString()}</p>
                    </div>
                    <div className="mt-3 pt-2 border-t border-gray-200 flex justify-between items-center">
                        {commit.mx_metadata ? <button onClick={() => setIsMetaVisible(!isMetaVisible)} className="text-xs text-blue-600 hover:underline">{isMetaVisible ? 'Hide' : 'Show'} Mendix Metadata</button> : <div />}
                        <div className="space-x-2">
                            <button onClick={() => onSelect('a', commit)} disabled={isSelectedA} className="px-2 py-1 text-xs font-semibold text-white bg-blue-500 rounded hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed">Set as A</button>
                            <button onClick={() => onSelect('b', commit)} disabled={isSelectedB} className="px-2 py-1 text-xs font-semibold text-white bg-green-500 rounded hover:bg-green-600 disabled:bg-green-300 disabled:cursor-not-allowed">Set as B</button>
                        </div>
                    </div>
                    {isMetaVisible && <div className="mt-2"><pre className="bg-gray-50 p-3 rounded-md text-xs text-gray-700 overflow-x-auto">{JSON.stringify(commit.mx_metadata, null, 2)}</pre></div>}
                </div>
            );
        };
        const DiffResultDisplay = ({ result }) => {
            if (!result || !result.unitDifferences || result.unitDifferences.length === 0) {
                return <div className="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">No differences found between the selected commits.</div>;
            }

            const ChangeDetail = ({ detail }) => (
                <li className="ml-4 text-sm">
                    <span className="font-semibold">{detail.changeDescription}:</span>
                    {detail.property && <span className="font-mono text-xs bg-gray-100 p-0.5 rounded ml-1">{detail.property}</span>}
                    {detail.baseValue && <div className="text-red-600 ml-2">- {detail.baseValue}</div>}
                    {detail.mineValue && <div className="text-green-600 ml-2">+ {detail.mineValue}</div>}
                    {detail.changeDetails && detail.changeDetails.length > 0 && (
                        <ul className="pl-4 border-l-2 border-gray-200">
                            {detail.changeDetails.map((subDetail, i) => <ChangeDetail key={i} detail={subDetail} />)}
                        </ul>
                    )}
                </li>
            );

            const ChangeBadge = ({ changeType }) => {
                const styles = {
                    'Added': 'bg-green-100 text-green-800',
                    'Deleted': 'bg-red-100 text-red-800',
                    'Modified': 'bg-yellow-100 text-yellow-800',
                    'Moved': 'bg-blue-100 text-blue-800'
                };
                return <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${styles[changeType] || 'bg-gray-100 text-gray-800'}`}>{changeType}</span>;
            };

            return (
                <div className="mt-6 p-4 border border-gray-300 rounded-lg bg-white shadow-inner">
                    <h3 className="text-lg font-semibold text-gray-800 mb-3">Comparison Result</h3>
                    <div className="space-y-4">
                        {result.unitDifferences.map((diff, index) => (
                            <div key={diff.id || index} className="p-3 bg-gray-50 rounded-md border border-gray-200">
                                <div className="flex justify-between items-center mb-2">
                                    <p className="font-semibold text-gray-700">{diff.type}</p>
                                    <ChangeBadge changeType={diff.change} />
                                </div>
                                <p className="text-xs font-mono text-gray-500 mb-2" title={diff.id}>{diff.id}</p>
                                {diff.changeDetails && diff.changeDetails.length > 0 && (
                                    <ul className="list-disc list-inside space-y-1">
                                        {diff.changeDetails.map((detail, i) => <ChangeDetail key={i} detail={detail} />)}
                                    </ul>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        const HistoryAndDiffPanel = () => {
            const { execute: fetchLog, isLoading: isLogLoading, error: logError, data: logData } = useRpc('git:getLog');
            const [commits, setCommits] = useState([]);
            const [page, setPage] = useState(1);
            const hasMore = logData?.hasMore ?? true;

            // The new job hook for the diff operation
            const { status, progress, data: diffResult, error: diffError, start: runDiff } = useJob('diff:run');
            const [selectedCommits, setSelectedCommits] = useState({ a: null, b: null });

            useEffect(() => { fetchLog({ page: 1, pageSize: 20 }); }, []);
            useEffect(() => {
                if (logData?.commits) {
                    setCommits(prev => page === 1 ? logData.commits : [...prev, ...logData.commits]);
                }
            }, [logData, page]);

            const loadMore = () => { const nextPage = page + 1; setPage(nextPage); fetchLog({ page: nextPage, pageSize: 20 }); }
            const handleSelectCommit = (slot, commit) => setSelectedCommits(prev => ({ ...prev, [slot]: commit }));
            const handleClearSelection = () => setSelectedCommits({ a: null, b: null });
            const handleCompare = () => {
                const { a, b } = selectedCommits;
                if (a && b) {
                    const oldCommit = new Date(a.date) <= new Date(b.date) ? a.sha : b.sha;
                    const newCommit = new Date(a.date) > new Date(b.date) ? a.sha : b.sha;
                    runDiff({ oldCommit, newCommit });
                }
            };

            // Note: Assuming DiffControlPanel, DiffResultDisplay, and CommitView components are defined elsewhere
            // with similar props as the old application for brevity.
            const isJobRunning = status === 'starting' || status === 'running';

            return (
                <div className="h-full flex flex-col">
                    <h2 className="text-xl font-semibold text-gray-700 mb-4 flex-shrink-0">Commit History & Comparison</h2>

                    <div className="flex-shrink-0">
                        <DiffControlPanel selected={selectedCommits} onCompare={handleCompare} onClear={handleClearSelection} isLoading={isJobRunning} />
                        <DiffProgressDisplay progress={progress} status={status} />
                        {status === 'error' && <ErrorDisplay error={diffError} />}
                        {status === 'success' && <DiffResultDisplay result={diffResult} />}
                    </div>

                    <div className="flex-grow overflow-y-auto mt-4 pr-2 space-y-3">
                        {isLogLoading && commits.length === 0 && <p className="text-center text-gray-500">Loading history...</p>}
                        {logError && <ErrorDisplay error={logError} />}
                        {commits.map(commit => <CommitView key={commit.sha} commit={commit} onSelect={handleSelectCommit} selection={selectedCommits} />)}
                        {hasMore && !isLogLoading && <div className="text-center mt-4"><button onClick={loadMore} className="px-4 py-2 bg-gray-200 rounded-md">Load More</button></div>}
                    </div>
                </div>
            );
        };

        // ===================================================================
        // ==============     IOC & APP INITIALIZATION     ===================
        // ===================================================================

        const AppWithDependencies = connectDependencies(() => {
            return <AppShell />;
        }, [
            // --- Framework Registrations ---
            [IApiService, { useClass: ApiService }],
            [IPanelService, { useClass: PanelService }],

            // --- Business Logic Registrations (as Panels) ---
            [IPanel, { useValue: { id: 'repo-management', title: 'Repository', component: RepoManagementPanel, defaultActive: true } }],
            [IPanel, { useValue: { id: 'history-diff', title: 'History & Diff', component: HistoryAndDiffPanel, defaultActive: true } }],
        ]);

        const root = ReactDOM.createRoot(document.getElementById("app"));
        root.render(<AppWithDependencies />);
    </script>
</body>

</html>